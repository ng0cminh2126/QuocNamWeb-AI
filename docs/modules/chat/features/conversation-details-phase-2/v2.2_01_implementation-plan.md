# v2.2 File Attachment Display - Implementation Plan

> **Module:** Chat  
> **Feature:** File Attachment Display in Message Bubble  
> **Version:** 2.2  
> **Status:** ‚úÖ APPROVED - Ready for implementation  
> **Created:** 2026-01-08  
> **Approved:** 2026-01-08  
> **Estimated Effort:** 1.5 hours

---

## üìã Problem Statement

**Current Bug:**

Khi g·ª≠i file attachments (PDF, DOCX, XLSX, PPTX, etc.), tin nh·∫Øn KH√îNG hi·ªÉn th·ªã n·ªôi dung g√¨ c·∫£. Ch·ªâ c√≥:

- Sender name
- Timestamp
- Empty message bubble

**Root Cause:**

File: `src/features/portal/components/ChatMainContainer.tsx`

```tsx
// Current code ONLY handles:
const hasImage = /* check image MIME type */;

if (hasText) { /* render text */ }
if (hasImage) { /* render MessageImage */ }
// ‚ùå NO HANDLING for non-image files!
```

**Impact:**

- ‚ùå User kh√¥ng bi·∫øt file g√¨ ƒë√£ g·ª≠i
- ‚ùå User kh√¥ng th·ªÉ download file
- ‚ùå Poor UX - message appears "empty"

---

## üéØ Solution Overview

### Phase 2 (v2.2) - File Display in Message Bubble

**Deliverable:** Display file attachments trong message bubble v·ªõi icon + filename

**Features:**

1. ‚úÖ **File icon ri√™ng theo lo·∫°i file** (S·ª≠ d·ª•ng Lucide icons kh√°c nhau):\n - PDF ‚Üí Lucide icon ri√™ng cho PDF (n·∫øu c√≥) ho·∫∑c `FileText` (red-600)\n - Word ‚Üí Lucide icon ri√™ng cho Word (n·∫øu c√≥ `FileType2` ho·∫∑c t∆∞∆°ng t·ª±) (blue-600) \n - Excel ‚Üí `Sheet` icon (green-600) ‚úÖ Already different\n - PowerPoint ‚Üí `Presentation` icon (orange-600) ‚úÖ Already different\n - Generic ‚Üí `File` icon (gray-600) ‚úÖ Already different\n - **v2.2 Update:** Ki·ªÉm tra Lucide icons m·ªõi nh·∫•t ƒë·ªÉ c√≥ icon ri√™ng cho PDF/Word n·∫øu available\n2. ‚úÖ Filename display (truncate if too long)\n3. ‚úÖ File size display (optional, if available from API)\n4. ‚úÖ Click behavior: Download file (open in new tab)\n5. ‚úÖ Consistent spacing v·ªõi image/text messages

**Note:** Hi·ªán t·∫°i v2.1 ƒë√£ implement nh∆∞ng PDF v√† Word ƒë·ªÅu d√πng `FileText`. C·∫ßn update `fileIconMapping.ts` ƒë·ªÉ distinguish gi·ªØa PDF v√† Word n·∫øu Lucide c√≥ icon ri√™ng.

**NOT in Scope (Phase 3 - Future):**

- ‚ùå File preview modal (PDF viewer, etc.)
- ‚ùå File download functionality (click to download)
- ‚ùå Download progress indicator
- ‚ùå File upload progress in file bubble

---

## üìÇ Files to Modify

### 1. ChatMainContainer.tsx

**Location:** `src/features/portal/components/ChatMainContainer.tsx`

**Changes:**

```tsx
// BEFORE (current - v2.1):
{(() => {
  const hasText = message.content && message.content.trim().length > 0;
  const hasImage = message.attachments && /* check image MIME */;
  const hasMixedContent = hasText && hasImage;

  return (
    <>
      {hasText && <div className={...}>...</div>}
      {hasMixedContent && <div className="h-2" />}
      {hasImage && <MessageImage ... />}
    </>
  );
})()}

// AFTER (v2.2):
{(() => {
  const hasText = message.content && message.content.trim().length > 0;
  const hasImage = message.attachments && message.attachments[0].contentType?.startsWith("image/");
  const hasFile = message.attachments && message.attachments.length > 0 && !hasImage;
  const hasMixedContent = hasText && (hasImage || hasFile);

  return (
    <>
      {/* Text */}
      {hasText && (
        <div className={hasMixedContent ? "px-4 pt-2" : "px-4 py-2"}>
          <p className="text-sm">{message.content}</p>
        </div>
      )}

      {/* Gap */}
      {hasMixedContent && <div className="h-2" />}

      {/* Image */}
      {hasImage && <MessageImage ... />}

      {/* File (NEW v2.2) - Display only, no download */}
      {hasFile && (
        <div
          className={cn(
            "flex items-center gap-3",
            hasText ? "px-4 pb-3" : "px-4 py-3"
          )}
          data-testid="file-attachment"
        >
          <FileIcon
            mimeType={message.attachments[0].contentType}
            size="md"
          />
          <div className="flex-1 min-w-0">
            <p className="text-sm font-medium truncate">
              {message.attachments[0].fileName || "File"}
            </p>
            {message.attachments[0].fileSize && (
              <p className="text-xs text-gray-500">
                {formatFileSize(message.attachments[0].fileSize)}
              </p>
            )}
          </div>
        </div>
      )}
    </>
  );
})()}
```

**New Imports:**

```tsx
import { FileIcon } from "@/components/FileIcon"; // Already exists from v2.1
import { cn } from "@/lib/utils";
```

**New Util Function (optional):**

```tsx
// If fileSize is available from API
function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}
```

---

## üß™ Testing Requirements

### Manual Testing Checklist

**Test Case 1: File-only Message (PDF)**

- [ ] Upload PDF file ‚Üí Message hi·ªÉn th·ªã:
  - [ ] PDF icon (red color)
  - [ ] Filename
  - [ ] File size (if available)
  - [ ] KH√îNG c√≥ download link/button
- [ ] Click v√†o file ‚Üí KH√îNG c√≥ action (Phase 3: preview modal)
- [ ] Padding: `px-4 py-3`

**Test Case 2: Text + File Message**

- [ ] Send "Here's the report" + PDF attachment
- [ ] Message hi·ªÉn th·ªã:
  - [ ] Text v·ªõi padding `px-4 pt-2`
  - [ ] Gap `h-2` (8px)
  - [ ] File v·ªõi padding `px-4 pb-3`
  - [ ] File KH√îNG c√≥ download link
- [ ] Click file ‚Üí KH√îNG c√≥ action

**Test Case 3: Different File Types & Icons**

- [ ] PDF ‚Üí Icon ri√™ng (ho·∫∑c `FileText` n·∫øu ch∆∞a c√≥) - red color - Visually distinct from Word
- [ ] DOCX ‚Üí Icon ri√™ng (ho·∫∑c `FileText` kh√°c PDF) - blue color - Visually distinct from PDF
- [ ] XLSX ‚Üí `Sheet` icon - green color ‚úÖ Already different
- [ ] PPTX ‚Üí `Presentation` icon - orange color ‚úÖ Already different
- [ ] Generic file (.zip) ‚Üí `File` icon - gray color ‚úÖ Already different
- [ ] **CRITICAL:** PDF v√† Word icon PH·∫¢I kh√°c nhau (kh√¥ng ch·ªâ m√†u)

**Test Case 4: Long Filename**

- [ ] Upload file v·ªõi t√™n d√†i (> 50 chars)
- [ ] Filename truncates v·ªõi `...`
- [ ] Kh√¥ng b·ªã overflow bubble

**Test Case 5: Mobile Responsive**

- [ ] File display tr√™n mobile (<640px)
- [ ] Icon + filename + size v·ª´a v·∫∑n
- [ ] Click v·∫´n ho·∫°t ƒë·ªông

---

## üìê Spacing Reference

| Message Type | Text Padding | Gap   | File/Image Padding |
| ------------ | ------------ | ----- | ------------------ |
| Text only    | `px-4 py-2`  | -     | -                  |
| Image only   | -            | -     | (no padding)       |
| File only    | -            | -     | `px-4 py-3`        |
| Text + Image | `px-4 pt-2`  | `h-2` | (no padding)       |
| Text + File  | `px-4 pt-2`  | `h-2` | `px-4 pb-3`        |

---

## üé® UI Mockup (Text)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Message Bubble (file only)              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  [üìÑ] Report_Q4_2024.pdf                ‚îÇ  ‚Üê px-4 py-3
‚îÇ       1.2 MB                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Message Bubble (text + file)            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Here's the quarterly report            ‚îÇ  ‚Üê px-4 pt-2
‚îÇ                                          ‚îÇ  ‚Üê h-2 gap
‚îÇ  [üìÑ] Report_Q4_2024.pdf                ‚îÇ  ‚Üê px-4 pb-3
‚îÇ       1.2 MB                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Note: NO download icon, NO click action in v2.2
```

---

## ‚úÖ PENDING DECISIONS (C·∫ßn HUMAN x√°c nh·∫≠n)

| #   | Decision              | Options                  | HUMAN Decision                |
| --- | --------------------- | ------------------------ | ----------------------------- |
| 1   | Show file size?       | Yes / No / Optional      | ‚¨ú **No**                     |
| 2   | Filename max length?  | 50 chars / 100 chars     | ‚¨ú **50 chars**               |
| 3   | Show file type badge? | Yes (e.g., "PDF") / No   | ‚¨ú **Yes**                    |
| 4   | File click behavior?  | No action / Future modal | ‚¨ú **Future modal - Phase 3** |

---

## üìã IMPACT SUMMARY

### Files s·∫Ω s·ª≠a ƒë·ªïi:

- `src/features/portal/components/ChatMainContainer.tsx`
  - Th√™m `hasFile` detection logic
  - Th√™m file attachment rendering block
  - Th√™m imports: `Download` icon, `FileIcon`, `formatFileSize` util

### Files s·∫Ω t·∫°o m·ªõi:

- (None - reuse existing `FileIcon` component)
- (Optional) `src/utils/formatFileSize.ts` n·∫øu mu·ªën t√°ch ri√™ng

### Dependencies th√™m:

- (None - s·ª≠ d·ª•ng existing Lucide icons)

---

## ‚è≥ HUMAN CONFIRMATION

| H·∫°ng m·ª•c                  | Status       |
| ------------------------- | ------------ |
| ƒê√£ review Impact Summary  | ‚úÖ ƒê√£ review |
| ƒê√£ ƒëi·ªÅn Pending Decisions | ‚úÖ ƒê√£ ƒëi·ªÅn   |
| **APPROVED ƒë·ªÉ th·ª±c thi**  | ‚úÖ APPROVED  |

**HUMAN Signature:** [ƒê√É DUY·ªÜT]  
**Date:** 2026-01-08

> ‚ö†Ô∏è **CRITICAL: AI KH√îNG ƒê∆Ø·ª¢C vi·∫øt code n·∫øu m·ª•c "APPROVED ƒë·ªÉ th·ª±c thi" = ‚¨ú CH∆ØA APPROVED**

---

## üîó Related Documents

- [01_requirements.md](./01_requirements.md) - v2.2 requirements updated
- [04_implementation-plan.md](./04_implementation-plan.md) - v2.0/v2.1 implementation
- [05_progress.md](./05_progress.md) - Implementation progress (will update after v2.2)

---

**Next Steps After Approval:**

1. HUMAN ƒëi·ªÅn Pending Decisions
2. HUMAN tick ‚úÖ APPROVED
3. AI implement file attachment display
4. AI run manual tests
5. AI update progress document
