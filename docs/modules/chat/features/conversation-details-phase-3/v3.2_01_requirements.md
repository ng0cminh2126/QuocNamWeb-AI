# [B∆Ø·ªöC 1] Phase 3.2 Requirements: Extended File Type Support

> **Module:** Chat  
> **Feature:** File Preview Modal - Extended File Types  
> **Version:** 3.2  
> **Status:** ‚úÖ APPROVED - Ready for wireframe  
> **Created:** 2026-01-09  
> **Base Version:** 3.0 (PDF + Basic Images)

---

## üìã Version History

| Version | Date       | Changes                                            | Status      |
| ------- | ---------- | -------------------------------------------------- | ----------- |
| 3.0     | 2026-01-08 | Initial: PDF multi-page + basic image preview      | ‚úÖ APPROVED |
| 3.2     | 2026-01-09 | Extended: Document files + improved image handling | ‚úÖ APPROVED |

---

## üéØ Overview

**What's New in v3.2?**

M·ªü r·ªông kh·∫£ nƒÉng preview t·ª´ ch·ªâ PDF sang t·∫•t c·∫£ document files ph·ªï bi·∫øn (Word, Excel, PowerPoint) v·ªõi c√πng UX nh∆∞ PDF (multi-page navigation).

**Changes from v3.0:**

| Feature Area    | v3.0 (Base)                    | v3.2 (Extended)                                     |
| --------------- | ------------------------------ | --------------------------------------------------- |
| PDF Files       | ‚úÖ Multi-page v·ªõi pagination   | ‚úÖ Gi·ªØ nguy√™n                                       |
| Image Files     | ‚úÖ Single image, no pagination | ‚úÖ **Modal UI gi·ªëng PDF, kh√¥ng c√≥ page navigation** |
| Word/Excel/PPT  | ‚ùå Not supported               | ‚úÖ **Multi-page nh∆∞ PDF**                           |
| Other Doc Types | ‚ùå Not supported               | ‚úÖ **Multi-page nh∆∞ PDF**                           |
| API Endpoints   | 2 endpoints (preview + render) | ‚úÖ Gi·ªØ nguy√™n (backend x·ª≠ l√Ω conversion)            |
| UI Modal        | Different for PDF vs Image     | ‚úÖ **Unified modal cho t·∫•t c·∫£ file types**          |
| Page Navigation | Only for PDF                   | ‚úÖ **For PDF + Documents, not for images**          |
| Loading States  | Per file type                  | ‚úÖ Unified loading skeleton                         |

**Why This Extension?**

- User c·∫ßn preview Word/Excel/PPT documents m√† kh√¥ng c·∫ßn download
- Tr·∫£i nghi·ªám nh·∫•t qu√°n cho m·ªçi file type (c√πng modal, c√πng controls)
- Image files c≈©ng n√™n c√≥ modal UI gi·ªëng nhau thay v√¨ UI kh√°c bi·ªát

---

## üìê Extended Functional Requirements

### FR-5: Document Files Multi-Page Support (NEW)

**ID:** FR-5  
**Priority:** HIGH  
**Description:** H·ªó tr·ª£ preview document files (DOC, DOCX, XLS, XLSX, PPT, PPTX) v·ªõi multi-page navigation gi·ªëng PDF

**Supported File Types:**

| File Type       | Extensions       | Backend Conversion | Rendering       |
| --------------- | ---------------- | ------------------ | --------------- |
| Microsoft Word  | .doc, .docx      | ‚úÖ To PNG pages    | Multi-page      |
| Microsoft Excel | .xls, .xlsx      | ‚úÖ To PNG pages    | Multi-page      |
| Microsoft PPT   | .ppt, .pptx      | ‚úÖ To PNG pages    | Multi-page      |
| OpenDocument    | .odt, .ods, .odp | ‚úÖ To PNG pages    | Multi-page      |
| Text/Rich Text  | .txt, .rtf       | ‚úÖ To PNG pages    | Single/Multi    |
| Images          | .jpg, .png, .gif | ‚úÖ Direct display  | Single (no nav) |

**Acceptance Criteria:**

‚úÖ **API Integration:**

- Same endpoints as PDF: `GET /api/Files/{id}/preview` v√† `GET /api/pdf/{fileId}/pages/{pageNumber}/render`
- Backend t·ª± ƒë·ªông detect file type v√† convert sang PNG pages
- Response headers `X-Total-Pages` v√† `X-Current-Page` gi·ªëng PDF
- Frontend KH√îNG c·∫ßn bi·∫øt file type g·ªëc l√† g√¨ (backend abstraction)

‚úÖ **UI/UX:**

- Modal UI gi·ªëng h·ªát PDF preview (header + content + navigation footer)
- Page navigation controls hi·ªÉn th·ªã cho multi-page documents
- Excel sheets: M·ªói sheet = 1 page
- PowerPoint slides: M·ªói slide = 1 page
- Word pages: M·ªói trang = 1 page

‚úÖ **Performance:**

- Cache pages nh∆∞ PDF (session-based)
- DPI = 300 (same as PDF)
- Lazy loading (ch·ªâ load page hi·ªán t·∫°i)
- Preload next page option (configurable)

**Technical Notes:**

```typescript
// Frontend kh√¥ng c·∫ßn ph√¢n bi·ªát file type
// API tr·∫£ v·ªÅ same format cho m·ªçi file type:

Response Headers:
  X-Total-Pages: 5
  X-Current-Page: 1
  Content-Type: image/png

Response Body: Binary PNG image
```

---

### FR-6: Unified Image Preview (UPDATED from FR-4)

**ID:** FR-6 (replaces FR-4)  
**Priority:** HIGH  
**Description:** Image files c≈©ng s·ª≠ d·ª•ng modal UI gi·ªëng document files, nh∆∞ng KH√îNG hi·ªÉn th·ªã page navigation

**Changes from v3.0:**

| Aspect             | v3.0 (Old)           | v3.2 (New)                                     |
| ------------------ | -------------------- | ---------------------------------------------- |
| Modal Structure    | Simple image display | ‚úÖ Full modal v·ªõi header + content + footer    |
| Header             | Minimal/None         | ‚úÖ File name + close button (same as PDF)      |
| Footer Navigation  | No footer            | ‚úÖ Footer exists nh∆∞ng KH√îNG hi·ªÉn th·ªã controls |
| Keyboard Shortcuts | None                 | ‚úÖ ESC to close (same as PDF)                  |
| Loading State      | Simple spinner       | ‚úÖ Skeleton loader (same as documents)         |
| Error Handling     | Basic error message  | ‚úÖ Unified error state (same as documents)     |

**Acceptance Criteria:**

‚úÖ **Modal Consistency:**

- Image files m·ªü trong C√ôNG modal component nh∆∞ PDF/Documents
- Header hi·ªÉn th·ªã file name v√† close button
- Content area hi·ªÉn th·ªã image (fit container, max-width: 100%)
- Footer section t·ªìn t·∫°i nh∆∞ng KH√îNG hi·ªÉn th·ªã page navigation controls

‚úÖ **API Response:**

```typescript
// Image files API response:
Headers:
  X-Total-Pages: 1       // ‚úÖ Always 1 for images
  X-Current-Page: 1
  Content-Type: image/jpeg (ho·∫∑c image/png, image/gif)

// Frontend logic:
if (totalPages === 1) {
  // Hide navigation controls in footer
  // But keep footer structure for consistent spacing
}
```

‚úÖ **Visual Behavior:**

- Image centered trong content area
- Image maintains aspect ratio
- No page number indicator (v√¨ ch·ªâ c√≥ 1 page)
- Footer c√≥ th·ªÉ hi·ªÉn th·ªã file info (size, dimensions) thay v√¨ navigation

**Implementation Example:**

```tsx
function FilePreviewModal({ fileId }: Props) {
  const { currentPage, totalPages, imageUrl } = usePdfPreview(fileId);

  return (
    <Modal>
      <Header>
        <FileName />
        <CloseButton />
      </Header>

      <Content>
        <img src={imageUrl} alt="Preview" />
      </Content>

      <Footer>
        {totalPages > 1 ? (
          // Show navigation for multi-page files
          <PageNavigation />
        ) : (
          // Show file info or empty footer for images
          <FileInfo /> // Optional: "1920 √ó 1080 ‚Ä¢ 2.5 MB"
        )}
      </Footer>
    </Modal>
  );
}
```

---

## üé® Updated UI Requirements

### UR-5: Unified Modal Design for All File Types

**Principle:** "Same modal structure, conditional controls"

**Modal Components:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ HEADER (Always visible)                                     ‚îÇ
‚îÇ - File name: "Document.docx" or "Image.png"                 ‚îÇ
‚îÇ - Close button (X)                                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ CONTENT (Scrollable)                                        ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ   [Image/Page Display]                                      ‚îÇ
‚îÇ   - PDF/DOC/PPT: Page image                                 ‚îÇ
‚îÇ   - Image files: Single image                               ‚îÇ
‚îÇ                                                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ FOOTER (Always present, conditional content)                ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ Multi-page files:                                           ‚îÇ
‚îÇ   [‚óÑ Prev]    Page 2 of 5    [Next ‚ñ∫]                       ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ Single-page images:                                         ‚îÇ
‚îÇ   [File info: 1920 √ó 1080 ‚Ä¢ 2.5 MB]  or  [Empty]           ‚îÇ
‚îÇ                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Responsive Rules (Same for all file types):**

| Breakpoint | Modal Size    | Header | Content Padding | Footer |
| ---------- | ------------- | ------ | --------------- | ------ |
| Desktop    | 90vw √ó 90vh   | 60px   | 24px            | 70px   |
| Tablet     | 95vw √ó 95vh   | 55px   | 20px            | 65px   |
| Mobile     | 100vw √ó 100vh | 50px   | 16px            | 60px   |

---

### UR-6: File Type Indicators (Optional)

**Decision:** Hi·ªÉn th·ªã file type icon trong header?

| Option                          | Pros                    | Cons                |
| ------------------------------- | ----------------------- | ------------------- |
| Show icon (Word/Excel/PDF logo) | ‚úÖ User nh·∫≠n bi·∫øt nhanh | ‚ùå Cluttered header |
| No icon, text only              | ‚úÖ Clean, minimal UI    | ‚ùå √çt th√¥ng tin     |
| Show in footer                  | ‚úÖ Balanced             | ‚ùå Xa file name     |

> ‚è≥ **HUMAN Decision Required** (see HUMAN DECISIONS section)

---

## üîß API Integration Updates

### API Behavior for Different File Types

Backend PH·∫¢I support conversion cho c√°c file types sau:

**Endpoint:** `GET /api/Files/{id}/preview`

| File Extension   | Backend Process                 | Response Headers          | Response Body  |
| ---------------- | ------------------------------- | ------------------------- | -------------- |
| .pdf             | Extract page 1                  | X-Total-Pages: N          | PNG image      |
| .docx, .doc      | Convert to PDF ‚Üí Extract page 1 | X-Total-Pages: N          | PNG image      |
| .xlsx, .xls      | Convert sheets ‚Üí PNG pages      | X-Total-Pages: N (sheets) | PNG image      |
| .pptx, .ppt      | Convert slides ‚Üí PNG pages      | X-Total-Pages: N (slides) | PNG image      |
| .jpg, .png, .gif | Direct image                    | X-Total-Pages: 1          | Original image |
| .txt, .rtf       | Render to PNG                   | X-Total-Pages: 1 or N     | PNG image      |

**Endpoint:** `GET /api/pdf/{fileId}/pages/{pageNumber}/render?dpi=300`

- Works for ALL file types (not just PDF)
- Backend internally converts to pages
- Frontend kh√¥ng c·∫ßn bi·∫øt file type g·ªëc

**Contract Updates:**

> ‚úÖ API contract documented in [docs/api/chat/file-preview/contract.md](../../../../api/chat/file-preview/contract.md)

No changes to contract structure, ch·ªâ expand supported file types trong documentation.

---

## üß™ Updated Testing Requirements

### TR-4: Extended Manual Test Cases

**Test Case 5: Word Document Multi-Page**

```
GIVEN: Message has 3-page .docx attachment
WHEN: User clicks on Word file
THEN:
  - Modal opens v·ªõi document preview
  - Page indicator shows "Page 1 of 3"
  - Content shows first page rendered as PNG
  - Navigation controls enabled (Next)
WHEN: User navigates through pages
THEN:
  - Pages load correctly with watermark
  - Navigation works nh∆∞ PDF
```

**Test Case 6: Excel Spreadsheet Multi-Sheet**

```
GIVEN: Message has Excel file v·ªõi 5 sheets
WHEN: User clicks on Excel file
THEN:
  - Modal opens
  - Page indicator shows "Page 1 of 5" (m·ªói sheet = 1 page)
  - Each "page" shows 1 sheet rendered as image
```

**Test Case 7: PowerPoint Presentation**

```
GIVEN: Message has PowerPoint v·ªõi 10 slides
WHEN: User clicks on PPT file
THEN:
  - Modal opens
  - Page indicator shows "Page 1 of 10"
  - Each slide rendered as separate page
  - Navigation works smoothly
```

**Test Case 8: Image File (Updated)**

```
GIVEN: Message has JPG attachment (1920√ó1080)
WHEN: User clicks on image file
THEN:
  - Modal opens v·ªõi SAME header/footer structure
  - Image displays trong content area (fit width)
  - Footer KH√îNG hi·ªÉn th·ªã page navigation
  - Footer c√≥ th·ªÉ show file info: "1920 √ó 1080 ‚Ä¢ 2.5 MB"
  - ESC key closes modal (same as documents)
```

---

### TR-5: Unit Test Coverage Updates

**Updated Components:**

‚úÖ `FilePreviewModal.tsx` (updated)

- ‚úÖ Handles totalPages = 1 (images) ‚Üí hides navigation
- ‚úÖ Handles totalPages > 1 (documents) ‚Üí shows navigation
- ‚úÖ Displays file type icon (if enabled)
- ‚úÖ Footer shows file info for images
- ‚úÖ Works for .docx, .xlsx, .pptx files

‚úÖ `usePdfPreview.ts` (no changes needed)

- ‚úÖ Works with any file type (API abstraction)
- ‚úÖ Handles X-Total-Pages header correctly

**New Test File:**

‚úÖ `FilePreviewModal.test.tsx` - Add test cases:

- ‚úÖ "renders without navigation for totalPages = 1"
- ‚úÖ "shows file info in footer for images"
- ‚úÖ "displays correct file type icon for .docx"

---

## üöÄ Updated Out of Scope

Still out of scope for v3.2:

‚ùå Download button (use existing)  
‚ùå Zoom in/out for images  
‚ùå Full-screen mode  
‚ùå Print functionality  
‚ùå Edit/annotate documents  
‚ùå Real-time collaboration on documents  
‚ùå Audio/Video file preview (future phase)

---

## ‚è≥ HUMAN DECISIONS

| #   | Decision Point                  | Options                      | HUMAN Choice     |
| --- | ------------------------------- | ---------------------------- | ---------------- |
| 1   | File type icon in header?       | Yes / No / Footer            | ‚¨ú Footer        |
| 2   | Image footer content?           | File info / Empty / Download | ‚¨ú Empty         |
| 3   | Support .txt files?             | Yes / No                     | ‚¨ú Yes           |
| 4   | Fallback for unsupported types? | Download / Error message     | ‚¨ú Error message |

---

## üìã IMPACT SUMMARY

### Files S·ª≠a ƒê·ªïi:

- `src/components/FilePreviewModal.tsx`

  - ‚úèÔ∏è Add conditional footer rendering (navigation vs file info)
  - ‚úèÔ∏è Add file type icon display (if approved)
  - ‚úèÔ∏è Update layout for single-page images

- `src/hooks/usePdfPreview.ts`

  - ‚úèÔ∏è Rename to `useFilePreview.ts` (optional, API agnostic)
  - ‚úèÔ∏è No logic changes (already works for all types)

- `src/types/filePreview.ts`

  - ‚úèÔ∏è Add `FileInfo` type for footer display
  - ‚úèÔ∏è Expand `FileType` enum (if using explicit types)

- `src/components/__tests__/FilePreviewModal.test.tsx`
  - ‚úèÔ∏è Add test cases for totalPages = 1
  - ‚úèÔ∏è Add test cases for different file types

### Files T·∫°o M·ªõi:

- (Kh√¥ng c√≥ - reuse existing components)

### API Changes:

- **Backend:** Ph·∫£i support conversion cho .docx, .xlsx, .pptx ‚Üí PNG pages
- **Frontend:** No changes to API client (same endpoints)

### Dependencies Th√™m:

- (Kh√¥ng c√≥ - backend handles conversion)

---

## üìä Migration from v3.0

### Breaking Changes:

‚ùå **NO breaking changes** - v3.2 is backward compatible

### Code Migration:

```typescript
// v3.0 code KH√îNG C·∫¶N thay ƒë·ªïi
// Modal component already generic enough

// Optional rename for clarity:
// usePdfPreview.ts ‚Üí useFilePreview.ts
// But hook logic remains identical
```

### User Impact:

‚úÖ **No user re-training** - Same UX for all file types  
‚úÖ **Progressive enhancement** - New file types just work  
‚úÖ **Images get better UX** - Consistent modal instead of separate UI

---

## ‚úÖ HUMAN CONFIRMATION

| H·∫°ng M·ª•c                           | Status       |
| ---------------------------------- | ------------ |
| ƒê√£ review Impact Summary           | ‚úÖ ƒê√£ review |
| ƒê√£ ƒëi·ªÅn Pending Decisions          | ‚úÖ ƒê√£ ƒëi·ªÅn   |
| **APPROVED ƒë·ªÉ t·∫°o wireframe v3.2** | ‚úÖ APPROVED  |

**HUMAN Signature:** [ƒê√É DUY·ªÜT]  
**Date:** 2026-01-09

> ‚úÖ **APPROVED - AI c√≥ th·ªÉ ti·∫øn h√†nh t·∫°o wireframe v√† documents kh√°c**

---

**Created:** 2026-01-09  
**Approved:** 2026-01-09  
**Base Version:** 3.0  
**Next Step:** Create wireframe v3.2 (B∆Ø·ªöC 2A)
