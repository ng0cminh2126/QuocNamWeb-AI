# [BÆ¯á»šC 2B] Phase 3.2 Flow: Unified File Preview Logic

> **Module:** Chat  
> **Feature:** File Preview Modal - Extended File Types  
> **Version:** 3.2  
> **Status:** âœ… APPROVED  
> **Created:** 2026-01-09  
> **Dependencies:**
>
> - [v3.2_01_requirements.md](./v3.2_01_requirements.md) âœ… APPROVED
> - [v3.2_02a_wireframe.md](./v3.2_02a_wireframe.md) â³ PENDING

---

## ğŸ“‹ Version History

| Version | Date       | Changes                           | Status      |
| ------- | ---------- | --------------------------------- | ----------- |
| 3.0     | 2026-01-08 | PDF-specific flow with multi-page | âœ… APPROVED |
| 3.2     | 2026-01-09 | Generic flow for all file types   | âœ… APPROVED |

---

## ğŸ¯ Overview

**What Changed in v3.2 Flow?**

| Aspect              | v3.0 Flow                     | v3.2 Flow                                 |
| ------------------- | ----------------------------- | ----------------------------------------- |
| File Type Detection | Hard-coded for PDF vs Image   | âœ… **Generic based on X-Total-Pages**     |
| Multi-Page Logic    | PDF only                      | âœ… **All documents (PDF/Word/Excel/PPT)** |
| Single-Page Logic   | Images only                   | âœ… **Images + single-page documents**     |
| API Calls           | Different for PDF vs Image    | âœ… **Same endpoints for all types**       |
| Navigation Display  | Conditional on file extension | âœ… **Conditional on totalPages value**    |
| Error Handling      | File type specific            | âœ… **Unified error states**               |

**Design Principle:** "Frontend agnostic to file type - let backend convert, check totalPages for behavior"

---

## ğŸ”„ Main User Flow - All File Types

### Flow Diagram: File Click â†’ Preview Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER ACTION: Click on file attachment in message                â”‚
â”‚ File can be: PDF, Word, Excel, PowerPoint, Image, TXT           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Open Modal    â”‚
  â”‚ with          â”‚
  â”‚ loading state â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API CALL #1: GET /api/Files/{id}/preview                        â”‚
â”‚                                                                  â”‚
â”‚ Purpose: Fetch first page/image + metadata                      â”‚
â”‚ Headers: Authorization: Bearer {token}                          â”‚
â”‚ Response:                                                        â”‚
â”‚   - Body: Binary image (PNG/JPG)                                â”‚
â”‚   - Headers:                                                     â”‚
â”‚     â€¢ X-Total-Pages: N (number of pages/sheets/slides)          â”‚
â”‚     â€¢ X-Current-Page: 1                                          â”‚
â”‚     â€¢ Content-Type: image/png or image/jpeg                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚
         SUCCESS           FAIL (401/403/404/500)
            â”‚              â”‚
            â–¼              â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Parse Headers   â”‚  â”‚ Show Error State         â”‚
  â”‚ totalPages = N  â”‚  â”‚ Based on status code:    â”‚
  â”‚ currentPage = 1 â”‚  â”‚ â€¢ 401/403: "Tá»« chá»‘i truy cáº­p"â”‚
  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ 404: "KhÃ´ng tÃ¬m tháº¥y tá»‡p"  â”‚
        â”‚              â”‚ â€¢ 500: "Lá»—i mÃ¡y chá»§"    â”‚
        â”‚              â”‚ [Thá»­ láº¡i] [ÄÃ³ng]        â”‚
        â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Store Response Data           â”‚
â”‚ - imageBlob â†’ createObjectURL â”‚
â”‚ - imageUrl = URL.createObject â”‚
â”‚ - totalPages                  â”‚
â”‚ - currentPage = 1             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DECISION POINT: How many pages?                                 â”‚
â”‚ if (totalPages === 1)                                           â”‚
â”‚   â†’ Single-page flow (images, 1-page docs)                      â”‚
â”‚ else if (totalPages > 1)                                        â”‚
â”‚   â†’ Multi-page flow (PDF, Word, Excel, PPT with multiple pages) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚
  totalPages=1   totalPages>1
        â”‚             â”‚
        â–¼             â–¼
  [FLOW A]        [FLOW B]
  Single Page     Multi-Page
```

---

## ğŸ¯ FLOW A: Single-Page Display (Images + 1-page Documents)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Render Modal - Single Page Mode                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ HEADER: [Icon] {filename}                             [âœ•]  â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ CONTENT:                                                    â”‚ â”‚
â”‚ â”‚   <img src={imageUrl} />                                    â”‚ â”‚
â”‚ â”‚   - Centered in viewport                                    â”‚ â”‚
â”‚ â”‚   - Maintains aspect ratio                                  â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ FOOTER: [Empty]                                             â”‚ â”‚
â”‚ â”‚   - No navigation controls                                  â”‚ â”‚
â”‚ â”‚   - Empty space for consistent layout                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TÃ¹y chá»n tÆ°Æ¡ng tÃ¡c:                                             â”‚
â”‚ â€¢ Xem áº£nh/tÃ i liá»‡u                                              â”‚
â”‚ â€¢ Click nÃºt Ä‘Ã³ng [âœ•] â†’ ÄÃ³ng modal                               â”‚
â”‚ â€¢ Nháº¥n phÃ­m ESC â†’ ÄÃ³ng modal                                    â”‚
â”‚ â€¢ Click vÃ o backdrop â†’ ÄÃ³ng modal                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Khi Ä‘Ã³ng:                                                       â”‚
â”‚ 1. Revoke object URL: URL.revokeObjectURL(imageUrl)            â”‚
â”‚ 2. Clear state                                                  â”‚
â”‚ 3. Quay vá» giao diá»‡n chat                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Examples Handled by Flow A:**

- JPG/PNG/GIF images
- Single-page PDF
- Single-page Word document
- Single-sheet Excel file
- Single-slide PowerPoint
- Short TXT file (1 page)

---

## ğŸ¯ FLOW B: Multi-Page Navigation (PDF, Word, Excel, PPT)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Render Modal - Multi-Page Mode                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ HEADER: [Icon] {filename}                             [âœ•]  â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ CONTENT:                                                    â”‚ â”‚
â”‚ â”‚   <img src={currentPageUrl} />                              â”‚ â”‚
â”‚ â”‚   - Shows current page image                                â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ FOOTER: [â—„ Prev]  Page {current} of {total}  [Next â–º]      â”‚ â”‚
â”‚ â”‚   - Prev disabled if currentPage === 1                      â”‚ â”‚
â”‚ â”‚   - Next disabled if currentPage === totalPages             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”‚ User at Page 1, totalPages = 5
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TÃ¹y chá»n tÆ°Æ¡ng tÃ¡c:                                             â”‚
â”‚ â€¢ Click [Next â–º] â†’ Chuyá»ƒn sang trang tiáº¿p theo                  â”‚
â”‚ â€¢ Nháº¥n mÅ©i tÃªn pháº£i/xuá»‘ng â†’ Chuyá»ƒn sang trang tiáº¿p theo         â”‚
â”‚ â€¢ Click [â—„ Prev] â†’ Quay láº¡i trang trÆ°á»›c (vÃ´ hiá»‡u hÃ³a á»Ÿ p1)      â”‚
â”‚ â€¢ Nháº¥n mÅ©i tÃªn trÃ¡i/lÃªn â†’ Quay láº¡i trang trÆ°á»›c                  â”‚
â”‚ â€¢ Nháº¥n Home â†’ Nháº£y vá» trang 1                                   â”‚
â”‚ â€¢ Nháº¥n End â†’ Nháº£y tá»›i trang cuá»‘i                                â”‚
â”‚ â€¢ Click [âœ•] / ESC â†’ ÄÃ³ng modal                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”‚ User clicks [Next â–º]
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PAGE NAVIGATION LOGIC                                           â”‚
â”‚                                                                  â”‚
â”‚ Step 1: Check Cache                                             â”‚
â”‚   pageCache.has(fileId-pageNumber-dpi) ?                        â”‚
â”‚   â”œâ”€ YES â†’ Use cached URL                                       â”‚
â”‚   â””â”€ NO  â†’ Fetch from API                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Check Cache         â”‚
         â”‚ page2 cached?       â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
         â”‚             â”‚
      CACHED      NOT CACHED
         â”‚             â”‚
         â–¼             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Use cached  â”‚  â”‚ API CALL #2:                                â”‚
  â”‚ imageUrl    â”‚  â”‚ GET /api/pdf/{fileId}/pages/2/render?dpi=300â”‚
  â”‚             â”‚  â”‚                                             â”‚
  â”‚ Display     â”‚  â”‚ Response:                                   â”‚
  â”‚ immediately â”‚  â”‚ - Body: Binary PNG image (page 2)           â”‚
  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - Same watermark applied                    â”‚
        â”‚          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚
        â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          â”‚              â”‚
        â”‚       SUCCESS          FAIL
        â”‚          â”‚              â”‚
        â”‚          â–¼              â–¼
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  â”‚ Create URL    â”‚  â”‚ Show Error       â”‚
        â”‚  â”‚ from blob     â”‚  â”‚ "KhÃ´ng táº£i Ä‘Æ°á»£c" â”‚
        â”‚  â”‚ Store cache   â”‚  â”‚ [Thá»­ láº¡i] [Há»§y]  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                         â”‚
                         â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ Cáº­p nháº­t UI         â”‚
               â”‚ currentPage = 2     â”‚
               â”‚ Hiá»ƒn thá»‹ trang 2    â”‚
               â”‚ Cáº­p nháº­t buttons:   â”‚
               â”‚ - Prev: enabled     â”‚
               â”‚ - Next: enabled     â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ NgÆ°á»i dÃ¹ng tiáº¿p tá»¥c xem             â”‚
               â”‚ CÃ³ thá»ƒ chuyá»ƒn: 1 â† 2 â†’ 3 â†’ 4 â†’ 5    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Examples Handled by Flow B:**

- Multi-page PDF (5 pages)
- Word document (12 pages)
- Excel workbook (3 sheets)
- PowerPoint presentation (20 slides)
- Long TXT file (multiple pages)

---

## ğŸ”„ Sub-Flow: Page Cache Logic

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PAGE CACHE IMPLEMENTATION                                       â”‚
â”‚                                                                  â”‚
â”‚ Data Structure:                                                  â”‚
â”‚   pageCache: Map<string, string>                                â”‚
â”‚   totalPagesRef: Ref<number | null>                             â”‚
â”‚                                                                  â”‚
â”‚ Cache Key Format:                                               â”‚
â”‚   `${fileId}-${pageNumber}-${dpi}`                              â”‚
â”‚   Example: "abc123-1-300", "abc123-2-300"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ When fetching page N:                                           â”‚
â”‚                                                                  â”‚
â”‚ 1. Generate cache key                                           â”‚
â”‚    const key = `${fileId}-${pageNumber}-${dpi}`                 â”‚
â”‚                                                                  â”‚
â”‚ 2. Check cache                                                  â”‚
â”‚    const cached = pageCache.get(key)                            â”‚
â”‚                                                                  â”‚
â”‚ 3. If cached && totalPagesRef.current !== null:                 â”‚
â”‚    â†’ Return cached URL immediately                              â”‚
â”‚    â†’ No API call needed                                         â”‚
â”‚                                                                  â”‚
â”‚ 4. If NOT cached:                                               â”‚
â”‚    â†’ Call API endpoint                                          â”‚
â”‚    â†’ Create object URL from response blob                       â”‚
â”‚    â†’ Store in cache: pageCache.set(key, url)                    â”‚
â”‚    â†’ Store totalPages: totalPagesRef.current = totalPages       â”‚
â”‚    â†’ Return new URL                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dá»n dáº¹p Cache (khi Ä‘Ã³ng modal):                                â”‚
â”‚                                                                  â”‚
â”‚ 1. Revoke all object URLs:                                      â”‚
â”‚    pageCache.forEach(url => URL.revokeObjectURL(url))           â”‚
â”‚                                                                  â”‚
â”‚ 2. Clear cache:                                                 â”‚
â”‚    pageCache.clear()                                            â”‚
â”‚    totalPagesRef.current = null                                 â”‚
â”‚                                                                  â”‚
â”‚ 3. NgÄƒn memory leaks                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš¨ Error Handling Flows

### Error Flow 1: Loáº¡i tá»‡p khÃ´ng Ä‘Æ°á»£c há»— trá»£

```
NgÆ°á»i dÃ¹ng click vÃ o tá»‡p .xyz
  â”‚
  â–¼
API Call #1: GET /api/Files/{id}/preview
  â”‚
  â–¼
API tráº£ vá» 400 Bad Request
Body: { "error": "Unsupported file type" }
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hiá»ƒn thá»‹ tráº¡ng thÃ¡i lá»—i                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“„ KhÃ´ng Thá»ƒ Xem TrÆ°á»›c              â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ Loáº¡i tá»‡p nÃ y (.xyz) khÃ´ng Ä‘Æ°á»£c      â”‚ â”‚
â”‚ â”‚ há»— trá»£ Ä‘á»ƒ xem trÆ°á»›c.                â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ Há»— trá»£: PDF, Word, Excel, PPT,      â”‚ â”‚
â”‚ â”‚ áº¢nh (JPG, PNG, GIF), TXT            â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚           [ÄÃ³ng]                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Error Flow 2: Lá»—i máº¡ng

```
API Call tháº¥t báº¡i (timeout/offline)
  â”‚
  â–¼
Báº¯t lá»—i máº¡ng
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hiá»ƒn thá»‹ tráº¡ng thÃ¡i lá»—i                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸŒ Lá»—i Máº¡ng                         â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ KhÃ´ng thá»ƒ táº£i báº£n xem trÆ°á»›c.        â”‚ â”‚
â”‚ â”‚ Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i.          â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚     [Thá»­ láº¡i]        [ÄÃ³ng]         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”‚ NgÆ°á»i dÃ¹ng click [Thá»­ láº¡i]
  â”‚
  â–¼
Thá»­ láº¡i API Call #1
```

### Error Flow 3: Thiáº¿u header X-Total-Pages

```
API Call #1 thÃ nh cÃ´ng
  â”‚
  â–¼
Response headers thiáº¿u X-Total-Pages
  â”‚
  â–¼
Logic dá»± phÃ²ng:
  totalPages = 1 (giáº£ Ä‘á»‹nh single page)
  â”‚
  â–¼
Hiá»ƒn thá»‹ cháº¿ Ä‘á»™ single-page
Ghi warning vÃ o console
```

---

## ğŸ“Š State Machine Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MODAL STATE MACHINE                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    [IDLE]
      â”‚
      â”‚ User clicks file
      â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ OPENING â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚
       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ LOADING  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
       â”‚                   â”‚ Error
       â”‚ Success           â–¼
       â–¼              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  ERROR  â”‚
  â”‚ READY   â”‚         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â”‚
       â”‚                   â”‚ Retry
       â”‚ Navigate          â”‚
       â–¼                   â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
  â”‚ NAVIGATING   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Page loaded
       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ READY   â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Close
       â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ CLOSING  â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
    [IDLE]

MÃ´ táº£ cÃ¡c tráº¡ng thÃ¡i:
- IDLE: Modal chÆ°a má»Ÿ
- OPENING: Animation má»Ÿ modal
- LOADING: Äang táº£i trang Ä‘áº§u tiÃªn tá»« API
- READY: Trang Ä‘Ã£ táº£i, ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ tÆ°Æ¡ng tÃ¡c
- NAVIGATING: Äang táº£i trang khÃ¡c
- ERROR: Lá»—i API, hiá»ƒn thá»‹ tráº¡ng thÃ¡i lá»—i
- CLOSING: Animation Ä‘Ã³ng modal
```

---

## ğŸ”„ Sequence Diagram: Multi-Page Navigation

```
User          Component         Hook          API           Cache
 â”‚                â”‚              â”‚             â”‚             â”‚
 â”‚ Click file    â”‚              â”‚             â”‚             â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚             â”‚             â”‚
 â”‚                â”‚ Open modal  â”‚             â”‚             â”‚
 â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚             â”‚
 â”‚                â”‚              â”‚ GET preview â”‚             â”‚
 â”‚                â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
 â”‚                â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
 â”‚                â”‚              â”‚ image+headersâ”‚            â”‚
 â”‚                â”‚              â”‚             â”‚             â”‚
 â”‚                â”‚              â”‚ Store page 1â”‚             â”‚
 â”‚                â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚             â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Show page 1 â”‚             â”‚             â”‚
 â”‚                â”‚              â”‚             â”‚             â”‚
 â”‚ Click Next    â”‚              â”‚             â”‚             â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚             â”‚             â”‚
 â”‚                â”‚ Navigate(2) â”‚             â”‚             â”‚
 â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚             â”‚
 â”‚                â”‚              â”‚ Check cache â”‚             â”‚
 â”‚                â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                â”‚              â”‚ Cache miss  â”‚             â”‚
 â”‚                â”‚              â”‚             â”‚             â”‚
 â”‚                â”‚              â”‚ GET page 2  â”‚             â”‚
 â”‚                â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚
 â”‚                â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
 â”‚                â”‚              â”‚ image       â”‚             â”‚
 â”‚                â”‚              â”‚             â”‚             â”‚
 â”‚                â”‚              â”‚ Store page 2â”‚             â”‚
 â”‚                â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚             â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Show page 2 â”‚             â”‚             â”‚
 â”‚                â”‚              â”‚             â”‚             â”‚
 â”‚ Click Prev    â”‚              â”‚             â”‚             â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚             â”‚             â”‚
 â”‚                â”‚ Navigate(1) â”‚             â”‚             â”‚
 â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚             â”‚             â”‚
 â”‚                â”‚              â”‚ Check cache â”‚             â”‚
 â”‚                â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                â”‚              â”‚ Cache hit!  â”‚             â”‚
 â”‚                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚             â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Show page 1 â”‚             â”‚             â”‚
 â”‚                â”‚ (instant)   â”‚             â”‚             â”‚
```

---

## âŒ¨ï¸ Keyboard Navigation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KEYBOARD EVENT HANDLER                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NgÆ°á»i dÃ¹ng nháº¥n phÃ­m
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PhÃ¡t hiá»‡n phÃ­m Ä‘Æ°á»£c nháº¥n    â”‚
â”‚ document.addEventListener   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Switch (event.key):                                             â”‚
â”‚                                                                  â”‚
â”‚ case 'Escape':                                                  â”‚
â”‚   â†’ ÄÃ³ng modal                                                  â”‚
â”‚   â†’ Dá»n dáº¹p cache                                               â”‚
â”‚   â†’ Quay vá» chat                                                â”‚
â”‚                                                                  â”‚
â”‚ case 'ArrowRight':                                              â”‚
â”‚ case 'ArrowDown':                                               â”‚
â”‚   â†’ if (totalPages === 1) return (bá» qua náº¿u single-page)       â”‚
â”‚   â†’ if (currentPage < totalPages) navigate(currentPage + 1)     â”‚
â”‚                                                                  â”‚
â”‚ case 'ArrowLeft':                                               â”‚
â”‚ case 'ArrowUp':                                                 â”‚
â”‚   â†’ if (totalPages === 1) return                                â”‚
â”‚   â†’ if (currentPage > 1) navigate(currentPage - 1)              â”‚
â”‚                                                                  â”‚
â”‚ case 'Home':                                                    â”‚
â”‚   â†’ if (totalPages === 1) return                                â”‚
â”‚   â†’ navigate(1)                                                 â”‚
â”‚                                                                  â”‚
â”‚ case 'End':                                                     â”‚
â”‚   â†’ if (totalPages === 1) return                                â”‚
â”‚   â†’ navigate(totalPages)                                        â”‚
â”‚                                                                  â”‚
â”‚ default:                                                        â”‚
â”‚   â†’ Bá» qua                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ HUMAN CONFIRMATION

| Háº¡ng Má»¥c                                | Status       |
| --------------------------------------- | ------------ |
| ÄÃ£ review flow diagrams                 | âœ… ÄÃ£ review |
| ÄÃ£ check error handling flows           | âœ… ÄÃ£ review |
| ÄÃ£ check cache logic                    | âœ… ÄÃ£ review |
| **APPROVED Ä‘á»ƒ táº¡o implementation plan** | âœ… APPROVED  |

**HUMAN Signature:** [ÄÃƒ DUYá»†T]  
**Date:** 2026-01-09

> âš ï¸ **CRITICAL: AI KHÃ”NG ÄÆ¯á»¢C táº¡o implementation plan náº¿u chÆ°a APPROVED**

---

**Created:** 2026-01-09  
**Base Version:** 3.0  
**Next Step:** HUMAN review â†’ Create implementation plan v3.2 (BÆ¯á»šC 4)
