# [B∆Ø·ªöC 4] Phase 3.2 Implementation Plan: Extended File Types

> **Module:** Chat  
> **Feature:** File Preview Modal - Extended File Types  
> **Version:** 3.2  
> **Status:** ‚úÖ APPROVED  
> **Created:** 2026-01-09  
> **Dependencies:**
>
> - [v3.2_01_requirements.md](./v3.2_01_requirements.md) ‚úÖ APPROVED
> - [v3.2_02a_wireframe.md](./v3.2_02a_wireframe.md) ‚úÖ APPROVED
> - [v3.2_02b_flow.md](./v3.2_02b_flow.md) ‚úÖ APPROVED
> - [v3.2_06_testing.md](./v3.2_06_testing.md) ‚úÖ APPROVED

---

## üìã Version History

| Version | Date       | Changes                            | Status      |
| ------- | ---------- | ---------------------------------- | ----------- |
| 3.0     | 2026-01-08 | PDF-only implementation plan       | ‚úÖ APPROVED |
| 3.2     | 2026-01-09 | Extended file types implementation | ‚úÖ APPROVED |

---

## üéØ Overview

**Implementation Strategy:**

Phase 3.2 extends Phase 3.0's PDF preview to support **all document types** (Word, Excel, PowerPoint, TXT, Images) using a **unified modal design** with **conditional controls** based on `totalPages` value from API.

**Key Principle:** "Frontend agnostic to file type - backend handles conversion, frontend checks totalPages for behavior"

---

## üìä Implementation Scope

### Files to Modify (3 files)

| File                   | Lines Changed | Complexity | Reason                                              |
| ---------------------- | ------------- | ---------- | --------------------------------------------------- |
| `FilePreviewModal.tsx` | ~50 lines     | Medium     | Add Word/Excel/PPT/TXT handling, conditional footer |
| `usePdfPreview.ts`     | ~30 lines     | Low        | Rename + extend to generic file types               |
| `fileTypes.ts`         | ~20 lines     | Low        | Add new file type definitions                       |

**Total:** ~100 lines of changes (kh√¥ng ph·∫£i file m·ªõi, ch·ªâ modify existing)

### Files to Create (0 files)

**None** - T·∫•t c·∫£ logic ƒë√£ t·ªìn t·∫°i t·ª´ Phase 3.0, ch·ªâ c·∫ßn extend.

---

## üîÑ Implementation Steps

### Step 1: Update Type Definitions (fileTypes.ts)

**File:** `src/types/fileTypes.ts`

**Changes:**

```typescript
// ‚úÖ BEFORE (Phase 3.0)
export type SupportedFileType = "pdf" | "image";

export const SUPPORTED_FILE_EXTENSIONS = {
  pdf: [".pdf"],
  image: [".jpg", ".jpeg", ".png", ".gif", ".webp"],
} as const;

// ‚úÖ AFTER (Phase 3.2)
export type SupportedFileType =
  | "pdf"
  | "word"
  | "excel"
  | "powerpoint"
  | "text"
  | "image";

export const SUPPORTED_FILE_EXTENSIONS = {
  pdf: [".pdf"],
  word: [".doc", ".docx"],
  excel: [".xls", ".xlsx"],
  powerpoint: [".ppt", ".pptx"],
  text: [".txt", ".rtf"],
  image: [".jpg", ".jpeg", ".png", ".gif", ".webp"],
} as const;

export const FILE_TYPE_ICONS: Record<SupportedFileType, string> = {
  pdf: "üìÑ",
  word: "üìù",
  excel: "üìä",
  powerpoint: "üìΩÔ∏è",
  text: "üìÉ",
  image: "üñºÔ∏è",
};

export const FILE_TYPE_LABELS: Record<SupportedFileType, string> = {
  pdf: "PDF",
  word: "Word",
  excel: "Excel",
  powerpoint: "PowerPoint",
  text: "Text",
  image: "·∫¢nh",
};
```

**Test:** `src/types/__tests__/fileTypes.test.ts` (th√™m 3 test cases cho Word/Excel/PPT)

---

### Step 2: Rename & Extend Hook (usePdfPreview ‚Üí useFilePreview)

**File:** `src/hooks/queries/usePdfPreview.ts` ‚Üí **KH√îNG ƒë·ªïi t√™n file**, ch·ªâ export th√™m alias

**Changes:**

```typescript
// ‚úÖ Keep existing usePdfPreview for backward compatibility
export function usePdfPreview(fileId: string) {
  return useFilePreview(fileId); // Internal redirect
}

// ‚úÖ NEW: Generic hook for all file types
export function useFilePreview(fileId: string) {
  const pageCache = useRef<Map<string, string>>(new Map());
  const totalPagesRef = useRef<number | null>(null);

  const {
    data: firstPageData,
    isLoading,
    isError,
    error,
  } = useQuery({
    queryKey: ["file-preview", fileId, 1],
    queryFn: () => getFilePreview(fileId, 1), // Generic API call
    staleTime: 1000 * 60 * 5,
  });

  useEffect(() => {
    if (firstPageData) {
      const { imageUrl, totalPages } = firstPageData;
      pageCache.current.set(`${fileId}-1-300`, imageUrl);
      totalPagesRef.current = totalPages;
    }
  }, [firstPageData, fileId]);

  const fetchPage = useCallback(
    async (pageNumber: number) => {
      const cacheKey = `${fileId}-${pageNumber}-300`;
      const cached = pageCache.current.get(cacheKey);

      if (cached && totalPagesRef.current !== null) {
        return {
          imageUrl: cached,
          totalPages: totalPagesRef.current,
          currentPage: pageNumber,
        };
      }

      const data = await getFilePreview(fileId, pageNumber);
      pageCache.current.set(cacheKey, data.imageUrl);
      totalPagesRef.current = data.totalPages;
      return data;
    },
    [fileId]
  );

  const cleanup = useCallback(() => {
    pageCache.current.forEach((url) => URL.revokeObjectURL(url));
    pageCache.current.clear();
    totalPagesRef.current = null;
  }, []);

  return {
    firstPageData,
    isLoading,
    isError,
    error,
    fetchPage,
    cleanup,
    totalPages: totalPagesRef.current,
  };
}
```

**API Change:**

```typescript
// src/api/filePreview.api.ts

// ‚úÖ BEFORE
export async function getPdfPreview(fileId: string, pageNumber: number = 1) {
  // ...
}

// ‚úÖ AFTER - Rename to generic
export async function getFilePreview(fileId: string, pageNumber: number = 1) {
  const response = await apiClient.get(`/api/Files/${fileId}/preview`, {
    params: { page: pageNumber },
    responseType: "blob",
  });

  const totalPages = parseInt(
    response.headers["x-total-pages"] ||
      response.headers["X-Total-Pages"] ||
      "1",
    10
  );
  const currentPage = parseInt(
    response.headers["x-current-page"] ||
      response.headers["X-Current-Page"] ||
      "1",
    10
  );

  const imageBlob = response.data;
  const imageUrl = URL.createObjectURL(imageBlob);

  return { imageUrl, totalPages, currentPage };
}

// ‚úÖ Keep backward compatibility
export const getPdfPreview = getFilePreview;
```

**Tests:** `src/hooks/queries/__tests__/usePdfPreview.test.ts` (th√™m 5 test cases m·ªõi)

---

### Step 3: Update FilePreviewModal Component

**File:** `src/features/portal/workspace/FilePreviewModal.tsx`

**Changes:**

```typescript
// ‚úÖ BEFORE (Phase 3.0)
const { firstPageData, isLoading, fetchPage, cleanup, totalPages } =
  usePdfPreview(fileId);

// Render logic
{
  totalPages > 1 ? (
    <div className="footer">
      <Button onClick={handlePrev}>‚óÑ Trang tr∆∞·ªõc</Button>
      <span>
        Trang {currentPage} / {totalPages}
      </span>
      <Button onClick={handleNext}>Trang sau ‚ñ∫</Button>
    </div>
  ) : null;
}

// ‚úÖ AFTER (Phase 3.2)
const { firstPageData, isLoading, fetchPage, cleanup, totalPages } =
  useFilePreview(fileId);

// Determine file type from filename extension
const fileType = getFileType(file.name); // Helper function

// Conditional footer rendering
const shouldShowFooter = totalPages > 1;
const showFileTypeIcon = shouldShowFooter && fileType !== "image";

{
  shouldShowFooter ? (
    <div className="footer">
      <Button onClick={handlePrev} disabled={currentPage === 1}>
        ‚óÑ Trang tr∆∞·ªõc
      </Button>
      <div className="footer-center">
        {showFileTypeIcon && (
          <span className="file-type-icon">{FILE_TYPE_ICONS[fileType]}</span>
        )}
        <span className="page-indicator">
          Trang {currentPage} / {totalPages}
        </span>
      </div>
      <Button onClick={handleNext} disabled={currentPage === totalPages}>
        Trang sau ‚ñ∫
      </Button>
    </div>
  ) : (
    <div className="footer-empty" /> // Empty footer for single images
  );
}
```

**Helper Functions:**

```typescript
// src/utils/fileUtils.ts

export function getFileType(filename: string): SupportedFileType {
  const ext = filename.toLowerCase().split(".").pop() || "";

  for (const [type, extensions] of Object.entries(SUPPORTED_FILE_EXTENSIONS)) {
    if (extensions.includes(`.${ext}` as any)) {
      return type as SupportedFileType;
    }
  }

  return "image"; // Default fallback
}

export function isMultiPageDocument(totalPages: number): boolean {
  return totalPages > 1;
}
```

**Tests:** `src/features/portal/workspace/__tests__/FilePreviewModal.test.tsx` (th√™m 8 test cases m·ªõi)

---

### Step 4: Update Error Messages (Vietnamese)

**File:** `src/features/portal/workspace/FilePreviewModal.tsx`

**Error States:**

```typescript
const ERROR_MESSAGES: Record<number, string> = {
  400: "Lo·∫°i t·ªáp n√†y kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ ƒë·ªÉ xem tr∆∞·ªõc.",
  401: "T·ª´ ch·ªëi truy c·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.",
  403: "B·∫°n kh√¥ng c√≥ quy·ªÅn xem t·ªáp n√†y.",
  404: "Kh√¥ng t√¨m th·∫•y t·ªáp.",
  500: "L·ªói m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.",
};

const NETWORK_ERROR_MESSAGE =
  "Kh√¥ng th·ªÉ t·∫£i b·∫£n xem tr∆∞·ªõc. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.";

// In component
{
  isError && (
    <div className="error-state">
      <div className="error-icon">‚ö†Ô∏è</div>
      <div className="error-title">Kh√¥ng Th·ªÉ Xem Tr∆∞·ªõc</div>
      <div className="error-message">
        {error instanceof Error && error.message.includes("Network")
          ? NETWORK_ERROR_MESSAGE
          : ERROR_MESSAGES[error?.response?.status || 500]}
      </div>
      <div className="error-actions">
        <Button onClick={handleRetry}>Th·ª≠ l·∫°i</Button>
        <Button onClick={onClose}>ƒê√≥ng</Button>
      </div>
    </div>
  );
}
```

---

### Step 5: Add Loading States (Vietnamese)

**File:** `src/features/portal/workspace/FilePreviewModal.tsx`

```typescript
// Initial loading (first page)
{
  isLoading && !firstPageData && (
    <div className="loading-skeleton">
      <div className="loading-spinner" />
      <div className="loading-text">ƒêang t·∫£i trang 1...</div>
    </div>
  );
}

// Page navigation loading
{
  isNavigating && (
    <div className="loading-overlay">
      <div className="loading-spinner" />
      <div className="loading-text">ƒêang t·∫£i...</div>
    </div>
  );
}
```

---

## üß™ Testing Strategy

### Unit Tests (16 new tests)

**FilePreviewModal.test.tsx:** +8 tests

1. ‚úÖ TC-FM-v32-001: Word multi-page rendering (12 pages)
2. ‚úÖ TC-FM-v32-002: Excel multi-sheet rendering (3 sheets)
3. ‚úÖ TC-FM-v32-003: PowerPoint multi-slide rendering (20 slides)
4. ‚úÖ TC-FM-v32-004: TXT single-page rendering
5. ‚úÖ TC-FM-v32-005: Image empty footer rendering
6. ‚úÖ TC-FM-v32-006: Conditional footer based on totalPages
7. ‚úÖ TC-FM-v32-007: File type icon display in footer
8. ‚úÖ TC-FM-v32-008: Unsupported file type error message

**usePdfPreview.test.ts:** +5 tests

1. ‚úÖ TC-HP-v32-001: Generic file types handling
2. ‚úÖ TC-HP-v32-002: Image file (totalPages=1) handling
3. ‚úÖ TC-HP-v32-003: TXT multi-page handling
4. ‚úÖ TC-HP-v32-004: Cache works for all file types
5. ‚úÖ TC-HP-v32-005: Missing X-Total-Pages header fallback

**filePreview.api.test.ts:** +3 tests

1. ‚úÖ TC-API-v32-001: Case-insensitive header parsing
2. ‚úÖ TC-API-v32-002: Content-Type header handling
3. ‚úÖ TC-API-v32-003: 400 error for unsupported type

**Total:** 85 tests (69 from v3.0 + 16 new)

---

## üìã Implementation Checklist

### Phase 1: Type Definitions & Utils (Est: 30 mins)

- [ ] Update `fileTypes.ts` with new types
- [ ] Add `FILE_TYPE_ICONS` and `FILE_TYPE_LABELS`
- [ ] Create `getFileType()` helper in `fileUtils.ts`
- [ ] Create `isMultiPageDocument()` helper
- [ ] Write tests for new type definitions
- [ ] Run: `npm test src/types`

### Phase 2: API & Hook Updates (Est: 1 hour)

- [ ] Rename `getPdfPreview` ‚Üí `getFilePreview` in API
- [ ] Keep backward compatible alias
- [ ] Update case-insensitive header parsing
- [ ] Export `useFilePreview` hook (alias to `usePdfPreview`)
- [ ] Update hook to use generic `getFilePreview`
- [ ] Write 5 new hook tests
- [ ] Run: `npm test src/hooks/queries`

### Phase 3: Component Updates (Est: 1.5 hours)

- [x] Import `useFilePreview` instead of `usePdfPreview`
- [x] Add `getFileType()` call to determine file type
- [x] Implement conditional footer logic
- [x] Add file type icon in footer (conditional)
- [x] Add empty footer for single images
- [x] Update error messages to Vietnamese ‚úÖ (2026-01-09)
- [x] Update loading states to Vietnamese
- [x] Write 8 new component tests
- [x] Run: `npm test FilePreviewModal` ‚úÖ PASS

### Phase 4: Integration Testing (Est: 30 mins)

- [ ] Test Word file preview (multi-page)
- [ ] Test Excel file preview (multi-sheet)
- [ ] Test PowerPoint file preview (multi-slide)
- [ ] Test TXT file preview (single + multi-page)
- [ ] Test image preview (empty footer)
- [ ] Test unsupported file type error
- [ ] Test keyboard navigation (all file types)
- [ ] Run: `npm test` (all tests)

### Phase 5: Manual QA (Est: 30 mins)

- [ ] Upload & preview .docx file (12 pages)
- [ ] Upload & preview .xlsx file (3 sheets)
- [ ] Upload & preview .pptx file (20 slides)
- [ ] Upload & preview .txt file (single + multi-page)
- [ ] Upload & preview image (verify empty footer)
- [ ] Test error states (401, 404, 500)
- [ ] Test network error (disconnect WiFi)
- [ ] Test responsive (desktop, tablet, mobile)

---

## üìä Impact Summary

### Files Modified (3 files)

1. **`src/types/fileTypes.ts`**

   - Add Word/Excel/PPT/Text types
   - Add `FILE_TYPE_ICONS` and `FILE_TYPE_LABELS`
   - Impact: Type safety for new file types

2. **`src/hooks/queries/usePdfPreview.ts`**

   - Export `useFilePreview` alias
   - Internal use of `getFilePreview` API
   - Impact: Backward compatible, extends to all types

3. **`src/features/portal/workspace/FilePreviewModal.tsx`**
   - Use `useFilePreview` hook
   - Conditional footer rendering
   - File type icon display
   - Vietnamese error/loading messages
   - Impact: UI supports all file types

### Files Created (2 test files)

1. **`src/utils/__tests__/fileUtils.test.ts`** (new)

   - Tests for `getFileType()`
   - Tests for `isMultiPageDocument()`

2. **`src/utils/fileUtils.ts`** (new)
   - Helper functions for file type detection

### Dependencies Added

**None** - S·ª≠ d·ª•ng existing dependencies t·ª´ Phase 3.0.

---

## ‚ö° Performance Considerations

### Cache Strategy

- ‚úÖ **Unchanged from v3.0:** Page cache works for all file types
- ‚úÖ **Memory:** Cache cleared on modal close (prevent leaks)
- ‚úÖ **Network:** Cached pages not refetched

### API Calls

- ‚úÖ **Initial:** 1 API call for first page (all file types)
- ‚úÖ **Navigation:** 1 API call per page (if not cached)
- ‚úÖ **Single-page:** No additional calls after initial load

### Bundle Size

- ‚úÖ **Impact:** ~2KB increase (new type definitions + helpers)
- ‚úÖ **No new libraries:** Uses existing React Query, Axios

---

## üö® Risk Assessment

| Risk                                              | Probability | Impact | Mitigation                            |
| ------------------------------------------------- | ----------- | ------ | ------------------------------------- |
| Backend kh√¥ng h·ªó tr·ª£ X-Total-Pages cho Word/Excel | Medium      | High   | Fallback to totalPages=1, log warning |
| File type detection sai (edge cases)              | Low         | Medium | Comprehensive tests, default fallback |
| Performance v·ªõi file l·ªõn (100+ pages)             | Low         | Medium | Lazy loading, cache strategy          |
| Breaking changes cho Phase 3.0                    | Very Low    | High   | Backward compatible API aliases       |

---

## üìù Rollback Plan

N·∫øu c·∫ßn rollback v·ªÅ Phase 3.0:

1. Revert `fileTypes.ts` v·ªÅ old definitions
2. Revert `FilePreviewModal.tsx` v·ªÅ s·ª≠ d·ª•ng `usePdfPreview`
3. X√≥a `fileUtils.ts` v√† tests
4. Ch·∫°y: `git checkout v3.0 -- src/`

**No database changes** - Safe to rollback anytime.

---

## ‚úÖ HUMAN CONFIRMATION

| H·∫°ng M·ª•c                                   | Status       |
| ------------------------------------------ | ------------ |
| ƒê√£ review implementation steps             | ‚úÖ ƒê√£ review |
| ƒê√£ check test coverage (85 tests)          | ‚úÖ ƒê√£ review |
| ƒê√£ check impact summary (3 files modified) | ‚úÖ ƒê√£ review |
| ƒê√£ check backward compatibility            | ‚úÖ ƒê√£ review |
| **APPROVED ƒë·ªÉ b·∫Øt ƒë·∫ßu coding**             | ‚úÖ APPROVED  |

**HUMAN Signature:** [ƒê√É DUY·ªÜT]  
**Date:** 2026-01-09

> ‚úÖ **READY TO CODE:** All planning documents approved, implementation can begin.

---

## üìã Next Steps

1. ‚úÖ Create task tracking (B∆Ø·ªöC 5: progress.md)
2. ‚è≥ Start implementation Step 1 (Type Definitions)
3. ‚è≥ Continue with Steps 2-5
4. ‚è≥ Run all tests (85 tests should pass)
5. ‚è≥ Manual QA
6. ‚è≥ Create checkpoint

**Estimated Total Time:** ~3.5 hours  
**Complexity:** Medium (extending existing, not building new)

---

**Created:** 2026-01-09  
**Base Version:** 3.0  
**Implementation Ready:** ‚úÖ YES  
**Next Step:** Begin coding Step 1
