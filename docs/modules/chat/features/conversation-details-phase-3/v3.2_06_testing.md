# [B∆Ø·ªöC 6] Phase 3.2 Testing Requirements: Extended File Types

> **Module:** Chat  
> **Feature:** File Preview Modal - Extended File Types  
> **Version:** 3.2  
> **Status:** ‚úÖ APPROVED  
> **Created:** 2026-01-09  
> **Dependencies:**
>
> - [v3.2_01_requirements.md](./v3.2_01_requirements.md) ‚úÖ APPROVED
> - [v3.2_02a_wireframe.md](./v3.2_02a_wireframe.md) ‚úÖ APPROVED
> - [v3.2_02b_flow.md](./v3.2_02b_flow.md) ‚úÖ APPROVED

---

## üìã Version History

| Version | Date       | Changes                               | Status      |
| ------- | ---------- | ------------------------------------- | ----------- |
| 3.0     | 2026-01-08 | Test cases for PDF + basic images     | ‚úÖ APPROVED |
| 3.2     | 2026-01-09 | Extended tests for all document types | ‚úÖ APPROVED |

---

## üéØ Overview

**What's New in v3.2 Testing?**

| Test Category      | v3.0          | v3.2                                  |
| ------------------ | ------------- | ------------------------------------- |
| File Type Coverage | PDF + JPG/PNG | ‚úÖ + Word/Excel/PPT/TXT               |
| Single-Page Tests  | Images only   | ‚úÖ Images + 1-page documents          |
| Multi-Page Tests   | PDF only      | ‚úÖ PDF + Word/Excel/PPT               |
| Footer Conditional | Not tested    | ‚úÖ Test totalPages=1 hides navigation |
| Error States       | Basic         | ‚úÖ File size, unsupported type errors |
| Cache Tests        | PDF-specific  | ‚úÖ Generic cache for all types        |

---

## üìä Test Coverage Matrix

### Updated Implementation ‚Üí Test Mapping

| Implementation File                   | Test File                                            | New Tests v3.2 | Total Tests |
| ------------------------------------- | ---------------------------------------------------- | -------------- | ----------- |
| `src/components/FilePreviewModal.tsx` | `src/components/__tests__/FilePreviewModal.test.tsx` | +8             | 42 (34+8)   |
| `src/hooks/usePdfPreview.ts`          | `src/hooks/__tests__/usePdfPreview.test.tsx`         | +5             | 23 (18+5)   |
| `src/api/filePreview.api.ts`          | `src/api/__tests__/filePreview.api.test.ts`          | +3             | 20 (17+3)   |

**Total Tests:** 85 (69 from v3.0 + 16 new in v3.2)

---

## üß™ Detailed Test Cases

### 1. FilePreviewModal.tsx Component Tests (NEW in v3.2)

**File:** `src/components/__tests__/FilePreviewModal.test.tsx`

#### TC-FM-v32-001: Word Document Multi-Page

```typescript
describe("FilePreviewModal - v3.2 Extended File Types", () => {
  it("should display Word document with page navigation", async () => {
    // GIVEN
    const mockWordFile = {
      id: "word-123",
      name: "Report.docx",
      type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    };

    mockPreviewApi.mockResolvedValueOnce({
      data: new Blob(["page1"]),
      headers: {
        "x-total-pages": "5",
        "x-current-page": "1",
      },
    });

    // WHEN
    render(
      <FilePreviewModal fileId={mockWordFile.id} fileName={mockWordFile.name} />
    );

    // THEN
    await waitFor(() => {
      expect(screen.getByTestId("file-preview-modal")).toBeInTheDocument();
      expect(screen.getByText("Report.docx")).toBeInTheDocument();
      expect(
        screen.getByTestId("file-preview-page-indicator")
      ).toHaveTextContent("Page 1 of 5");
      expect(screen.getByTestId("file-preview-next-button")).toBeEnabled();
      expect(screen.getByTestId("file-preview-prev-button")).toBeDisabled();
    });
  });

  it("should navigate through Word document pages", async () => {
    // GIVEN - Word doc with 3 pages
    setupWordDocument(3);
    render(<FilePreviewModal fileId="word-123" fileName="Doc.docx" />);
    await waitForPageLoad();

    // WHEN - Navigate to page 2
    const nextButton = screen.getByTestId("file-preview-next-button");
    fireEvent.click(nextButton);

    // THEN
    await waitFor(() => {
      expect(
        screen.getByTestId("file-preview-page-indicator")
      ).toHaveTextContent("Page 2 of 3");
      expect(mockRenderApi).toHaveBeenCalledWith("word-123", 2, { dpi: 300 });
    });
  });
});
```

#### TC-FM-v32-002: Excel Spreadsheet Multi-Sheet

```typescript
it("should display Excel file with sheet navigation", async () => {
  // GIVEN
  const mockExcelFile = {
    id: "excel-456",
    name: "Data.xlsx",
  };

  mockPreviewApi.mockResolvedValueOnce({
    data: new Blob(["sheet1"]),
    headers: {
      "x-total-pages": "3", // 3 sheets
      "x-current-page": "1",
    },
  });

  // WHEN
  render(
    <FilePreviewModal fileId={mockExcelFile.id} fileName={mockExcelFile.name} />
  );

  // THEN
  await waitFor(() => {
    expect(screen.getByTestId("file-preview-page-indicator")).toHaveTextContent(
      "Page 1 of 3"
    );
    // Excel: Each sheet = 1 page
  });
});
```

#### TC-FM-v32-003: PowerPoint Presentation

```typescript
it("should display PowerPoint with slide navigation", async () => {
  // GIVEN
  const mockPPTFile = {
    id: "ppt-789",
    name: "Presentation.pptx",
  };

  mockPreviewApi.mockResolvedValueOnce({
    data: new Blob(["slide1"]),
    headers: {
      "x-total-pages": "15", // 15 slides
      "x-current-page": "1",
    },
  });

  // WHEN
  render(
    <FilePreviewModal fileId={mockPPTFile.id} fileName={mockPPTFile.name} />
  );

  // THEN
  await waitFor(() => {
    expect(screen.getByTestId("file-preview-page-indicator")).toHaveTextContent(
      "Page 1 of 15"
    );
  });

  // WHEN - Navigate to last slide
  const lastSlide = 15;
  for (let i = 1; i < lastSlide; i++) {
    fireEvent.click(screen.getByTestId("file-preview-next-button"));
    await waitFor(() => {
      expect(
        screen.getByTestId("file-preview-page-indicator")
      ).toHaveTextContent(`Page ${i + 1} of 15`);
    });
  }

  // THEN
  expect(screen.getByTestId("file-preview-next-button")).toBeDisabled();
});
```

#### TC-FM-v32-004: TXT File Support

```typescript
it("should display TXT file as single or multi-page", async () => {
  // GIVEN
  const mockTxtFile = {
    id: "txt-111",
    name: "README.txt",
  };

  mockPreviewApi.mockResolvedValueOnce({
    data: new Blob(["text content"]),
    headers: {
      "x-total-pages": "1", // Short text file
      "x-current-page": "1",
    },
  });

  // WHEN
  render(
    <FilePreviewModal fileId={mockTxtFile.id} fileName={mockTxtFile.name} />
  );

  // THEN
  await waitFor(() => {
    // Single page TXT ‚Üí no navigation
    expect(
      screen.queryByTestId("file-preview-page-indicator")
    ).not.toBeInTheDocument();
    expect(
      screen.queryByTestId("file-preview-next-button")
    ).not.toBeInTheDocument();
  });
});
```

#### TC-FM-v32-005: Image File - Empty Footer

```typescript
it("should display image with empty footer (no navigation)", async () => {
  // GIVEN
  const mockImageFile = {
    id: "img-222",
    name: "Photo.jpg",
  };

  mockPreviewApi.mockResolvedValueOnce({
    data: new Blob(["image data"]),
    headers: {
      "x-total-pages": "1",
      "x-current-page": "1",
    },
  });

  // WHEN
  render(
    <FilePreviewModal fileId={mockImageFile.id} fileName={mockImageFile.name} />
  );

  // THEN
  await waitFor(() => {
    const footer = screen.getByTestId("file-preview-footer");
    expect(footer).toBeInTheDocument();
    expect(footer).toBeEmptyDOMElement(); // Empty based on HUMAN Decision #2

    // No navigation controls
    expect(
      screen.queryByTestId("file-preview-page-indicator")
    ).not.toBeInTheDocument();
    expect(
      screen.queryByTestId("file-preview-next-button")
    ).not.toBeInTheDocument();
    expect(
      screen.queryByTestId("file-preview-prev-button")
    ).not.toBeInTheDocument();
  });
});
```

#### TC-FM-v32-006: File Size Exceeded Error

```typescript
it("should show error for files exceeding 20MB", async () => {
  // GIVEN
  const mockLargeFile = {
    id: "large-333",
    name: "HugeFile.pdf",
    size: 25 * 1024 * 1024, // 25 MB
  };

  // WHEN
  render(
    <FilePreviewModal
      fileId={mockLargeFile.id}
      fileName={mockLargeFile.name}
      fileSize={mockLargeFile.size}
    />
  );

  // THEN
  await waitFor(() => {
    expect(screen.getByTestId("file-preview-error-size")).toBeInTheDocument();
    expect(screen.getByText(/exceeds the maximum size/i)).toBeInTheDocument();
    expect(screen.getByText(/20 MB/i)).toBeInTheDocument();
    expect(mockPreviewApi).not.toHaveBeenCalled(); // No API call for oversized files
  });
});
```

#### TC-FM-v32-007: Unsupported File Type Error

```typescript
it("should show error for unsupported file types", async () => {
  // GIVEN
  mockPreviewApi.mockRejectedValueOnce({
    response: {
      status: 400,
      data: { error: "Unsupported file type" },
    },
  });

  // WHEN
  render(<FilePreviewModal fileId="unsupported-444" fileName="file.xyz" />);

  // THEN
  await waitFor(() => {
    expect(
      screen.getByTestId("file-preview-unsupported-error")
    ).toBeInTheDocument();
    expect(screen.getByText(/not supported for preview/i)).toBeInTheDocument();
    expect(screen.getByText(/Supported types:/i)).toBeInTheDocument();
    expect(
      screen.getByText(/PDF, Word, Excel, PowerPoint/i)
    ).toBeInTheDocument();
  });
});
```

#### TC-FM-v32-008: Conditional Footer Rendering

```typescript
it("should render footer with navigation for totalPages > 1", async () => {
  // GIVEN
  mockPreviewApi.mockResolvedValueOnce({
    data: new Blob(["page1"]),
    headers: { "x-total-pages": "5", "x-current-page": "1" },
  });

  // WHEN
  render(<FilePreviewModal fileId="multi-555" fileName="Doc.pdf" />);

  // THEN
  await waitFor(() => {
    const footer = screen.getByTestId("file-preview-footer");
    expect(footer).toBeInTheDocument();
    expect(
      within(footer).getByTestId("file-preview-page-indicator")
    ).toBeInTheDocument();
    expect(
      within(footer).getByTestId("file-preview-prev-button")
    ).toBeInTheDocument();
    expect(
      within(footer).getByTestId("file-preview-next-button")
    ).toBeInTheDocument();
  });
});

it("should render footer without navigation for totalPages = 1", async () => {
  // GIVEN
  mockPreviewApi.mockResolvedValueOnce({
    data: new Blob(["single page"]),
    headers: { "x-total-pages": "1", "x-current-page": "1" },
  });

  // WHEN
  render(<FilePreviewModal fileId="single-666" fileName="Image.png" />);

  // THEN
  await waitFor(() => {
    const footer = screen.getByTestId("file-preview-footer");
    expect(footer).toBeInTheDocument();
    expect(
      within(footer).queryByTestId("file-preview-page-indicator")
    ).not.toBeInTheDocument();
    expect(
      within(footer).queryByTestId("file-preview-prev-button")
    ).not.toBeInTheDocument();
    expect(
      within(footer).queryByTestId("file-preview-next-button")
    ).not.toBeInTheDocument();
  });
});
```

---

### 2. usePdfPreview.ts Hook Tests (NEW in v3.2)

**File:** `src/hooks/__tests__/usePdfPreview.test.tsx`

#### TC-HP-v32-001: Generic File Type Handling

```typescript
describe("usePdfPreview - v3.2 File Type Agnostic", () => {
  it("should work with Word document", async () => {
    // GIVEN
    mockPreviewApi.mockResolvedValueOnce({
      data: new Blob(["word page"]),
      headers: { "x-total-pages": "10", "x-current-page": "1" },
    });

    // WHEN
    const { result } = renderHook(() => usePdfPreview("word-doc-123"));

    // THEN
    await waitFor(() => {
      expect(result.current.state.totalPages).toBe(10);
      expect(result.current.state.currentPage).toBe(1);
      expect(result.current.state.imageUrl).toBeTruthy();
    });
  });

  it("should work with Excel spreadsheet", async () => {
    // GIVEN
    mockPreviewApi.mockResolvedValueOnce({
      data: new Blob(["excel sheet"]),
      headers: { "x-total-pages": "3", "x-current-page": "1" },
    });

    // WHEN
    const { result } = renderHook(() => usePdfPreview("excel-file-456"));

    // THEN
    await waitFor(() => {
      expect(result.current.state.totalPages).toBe(3); // 3 sheets
      expect(mockPreviewApi).toHaveBeenCalledWith("excel-file-456", {
        page: 1,
      });
    });
  });

  it("should work with PowerPoint presentation", async () => {
    // GIVEN
    mockPreviewApi.mockResolvedValueOnce({
      data: new Blob(["ppt slide"]),
      headers: { "x-total-pages": "20", "x-current-page": "1" },
    });

    // WHEN
    const { result } = renderHook(() => usePdfPreview("ppt-file-789"));

    // THEN
    await waitFor(() => {
      expect(result.current.state.totalPages).toBe(20); // 20 slides
    });
  });
});
```

#### TC-HP-v32-002: Image File Handling

```typescript
it("should handle single-page image file", async () => {
  // GIVEN
  mockPreviewApi.mockResolvedValueOnce({
    data: new Blob(["image data"], { type: "image/jpeg" }),
    headers: { "x-total-pages": "1", "x-current-page": "1" },
  });

  // WHEN
  const { result } = renderHook(() => usePdfPreview("image-123"));

  // THEN
  await waitFor(() => {
    expect(result.current.state.totalPages).toBe(1);
    expect(result.current.state.imageUrl).toBeTruthy();
    // Navigation should not be applicable
  });
});
```

#### TC-HP-v32-003: TXT File Multi-Page

```typescript
it("should handle multi-page TXT file", async () => {
  // GIVEN - Long TXT file rendered as 3 pages
  mockPreviewApi.mockResolvedValueOnce({
    data: new Blob(["text page 1"]),
    headers: { "x-total-pages": "3", "x-current-page": "1" },
  });

  // WHEN
  const { result } = renderHook(() => usePdfPreview("txt-file-999"));

  // THEN
  await waitFor(() => {
    expect(result.current.state.totalPages).toBe(3);
  });

  // WHEN - Navigate to page 2
  mockRenderApi.mockResolvedValueOnce({
    data: new Blob(["text page 2"]),
    headers: { "x-total-pages": "3", "x-current-page": "2" },
  });

  act(() => {
    result.current.goToPage(2);
  });

  // THEN
  await waitFor(() => {
    expect(result.current.state.currentPage).toBe(2);
    expect(mockRenderApi).toHaveBeenCalledWith("txt-file-999", 2, { dpi: 300 });
  });
});
```

#### TC-HP-v32-004: Cache Works for All File Types

```typescript
it("should cache pages for Word/Excel/PPT/TXT same as PDF", async () => {
  // GIVEN - Excel file with 3 sheets
  setupExcelFile(3);
  const { result } = renderHook(() => usePdfPreview("excel-cache-test"));
  await waitForPageLoad();

  // WHEN - Navigate to sheet 2
  act(() => result.current.goToPage(2));
  await waitForPageLoad();

  // WHEN - Navigate back to sheet 1
  act(() => result.current.goToPage(1));

  // THEN - Should use cache, no new API call
  await waitFor(() => {
    expect(result.current.state.currentPage).toBe(1);
    expect(mockRenderApi).toHaveBeenCalledTimes(1); // Only called for page 2
  });
});
```

#### TC-HP-v32-005: Missing Headers Fallback

```typescript
it("should fallback to totalPages = 1 if headers missing", async () => {
  // GIVEN - API response without X-Total-Pages
  mockPreviewApi.mockResolvedValueOnce({
    data: new Blob(["page"]),
    headers: {}, // No X-Total-Pages header
  });

  const consoleWarnSpy = vi.spyOn(console, "warn").mockImplementation();

  // WHEN
  const { result } = renderHook(() => usePdfPreview("no-headers-file"));

  // THEN
  await waitFor(() => {
    expect(result.current.state.totalPages).toBe(1); // Fallback
    expect(consoleWarnSpy).toHaveBeenCalledWith(
      expect.stringContaining("Missing X-Total-Pages")
    );
  });

  consoleWarnSpy.mockRestore();
});
```

---

### 3. filePreview.api.ts Tests (NEW in v3.2)

**File:** `src/api/__tests__/filePreview.api.test.ts`

#### TC-API-v32-001: Headers Case Insensitive

```typescript
describe("filePreview.api - v3.2 Extensions", () => {
  it("should parse X-Total-Pages case-insensitively", async () => {
    // GIVEN - Backend returns lowercase header
    mockAxios.get.mockResolvedValueOnce({
      data: new Blob([]),
      headers: {
        "x-total-pages": "5", // lowercase
        "x-current-page": "1",
      },
    });

    // WHEN
    const response = await getFilePreview("file-123");

    // THEN
    expect(response.headers["x-total-pages"]).toBe("5");
  });

  it("should parse X-Total-Pages with uppercase", async () => {
    // GIVEN - Backend returns uppercase header
    mockAxios.get.mockResolvedValueOnce({
      data: new Blob([]),
      headers: {
        "X-Total-Pages": "10", // uppercase
        "X-Current-Page": "1",
      },
    });

    // WHEN
    const response = await getFilePreview("file-456");

    // THEN
    expect(response.headers["X-Total-Pages"]).toBe("10");
  });
});
```

#### TC-API-v32-002: Content-Type Handling

```typescript
it("should handle different content types", async () => {
  const contentTypes = [
    "image/png",
    "image/jpeg",
    "image/gif",
    "application/pdf",
  ];

  for (const contentType of contentTypes) {
    // GIVEN
    mockAxios.get.mockResolvedValueOnce({
      data: new Blob([], { type: contentType }),
      headers: {
        "content-type": contentType,
        "x-total-pages": "1",
      },
    });

    // WHEN
    const response = await getFilePreview(`file-${contentType}`);

    // THEN
    expect(response.data.type).toBe(contentType);
  }
});
```

#### TC-API-v32-003: 400 Error for Unsupported Type

```typescript
it("should handle 400 error for unsupported file type", async () => {
  // GIVEN
  mockAxios.get.mockRejectedValueOnce({
    response: {
      status: 400,
      data: {
        error: "Unsupported file type",
        message: "File type .xyz is not supported",
      },
    },
  });

  // WHEN/THEN
  await expect(getFilePreview("unsupported-file")).rejects.toMatchObject({
    response: {
      status: 400,
      data: expect.objectContaining({
        error: "Unsupported file type",
      }),
    },
  });
});
```

---

## üìã Test Generation Checklist

### Before Implementation

- [x] Review requirements v3.2
- [x] Identify new file types to test
- [x] Define test cases for conditional footer
- [x] Define error cases (file size, unsupported type)
- [x] Plan cache tests for all file types

### During Implementation

- [ ] Write component tests (8 new cases)
- [ ] Write hook tests (5 new cases)
- [ ] Write API tests (3 new cases)
- [ ] Ensure data-testid attributes added
- [ ] Mock API responses for all file types

### After Implementation

- [ ] Run all tests: `npm test`
- [ ] Verify test coverage ‚â• 80%
- [ ] Check no console errors in tests
- [ ] Update test documentation

---

## üìä Expected Test Results

```bash
Test Suites: 3 passed, 3 total
Tests:       85 passed, 85 total
  - FilePreviewModal: 42 passed (34 from v3.0 + 8 new)
  - usePdfPreview: 23 passed (18 from v3.0 + 5 new)
  - filePreview.api: 20 passed (17 from v3.0 + 3 new)
Snapshots:   0 total
Time:        ~25s
Coverage:    ‚â• 80% (lines, functions, branches)
```

---

## ‚úÖ HUMAN CONFIRMATION

| H·∫°ng M·ª•c                                | Status       |
| --------------------------------------- | ------------ |
| ƒê√£ review test cases                    | ‚úÖ ƒê√£ review |
| ƒê√£ check test coverage matrix           | ‚úÖ ƒê√£ review |
| ƒê√£ check error scenarios                | ‚úÖ ƒê√£ review |
| **APPROVED ƒë·ªÉ t·∫°o implementation plan** | ‚úÖ APPROVED  |

**HUMAN Signature:** [ƒê√É DUY·ªÜT]  
**Date:** 2026-01-09

> ‚ö†Ô∏è **CRITICAL: AI KH√îNG ƒê∆Ø·ª¢C code n·∫øu testing requirements ch∆∞a APPROVED**

---

**Created:** 2026-01-09  
**Base Version:** 3.0 (69 tests)  
**New Tests:** +16 tests  
**Total Tests:** 85 tests  
**Next Step:** HUMAN review ‚Üí Create implementation plan v3.2 (B∆Ø·ªöC 4)
