# [BÆ¯á»šC 2B] Flow - Upgrade Conversation UX

> **Status:** â³ PENDING HUMAN APPROVAL  
> **Created:** 2026-01-07  
> **Version:** 1.0

---

## ðŸ”„ User Flows

### Flow 1: Receive New Message (Real-time Update)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USER A (Current User)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ 1. Äang xem Conversation X
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Conversation Xâ”‚ â† Active
                    â”‚ (no badge)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ 2. User B gá»­i tin trong Conversation Y
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚        SignalR Event: MessageSent     â”‚
        â”‚  { conversationId: Y, message: {...}} â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  3. Frontend xá»­ lÃ½:                         â”‚
        â”‚  âœ… Update conversation Y lastMessage       â”‚
        â”‚  âœ… Increment unreadCount (vÃ¬ Ä‘ang á»Ÿ X)    â”‚
        â”‚  âœ… Resort: Move Y to top                   â”‚
        â”‚  âœ… Flash effect on Y                       â”‚
        â”‚  âœ… Lock scroll position (khÃ´ng auto-scroll)â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Conversation Yâ”‚ â† Nháº£y lÃªn Ä‘áº§u, flash yellow
                    â”‚ [Badge: 1]    â”‚ â† Unread badge xuáº¥t hiá»‡n
                    â”‚ Latest msg... â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ Conversation Xâ”‚ â† Váº«n active, no badge
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ 4. User click vÃ o Conversation Y
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5. Frontend actions:                       â”‚
        â”‚  âœ… Switch active conversation X â†’ Y        â”‚
        â”‚  âœ… Call markConversationAsRead(Y)          â”‚
        â”‚  âœ… Hide unread badge                       â”‚
        â”‚  âœ… Load messages for Y                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Conversation Yâ”‚ â† Now active
                    â”‚ (no badge)    â”‚ â† Badge disappeared
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Edge Cases:**

**Case 1.1: Multiple messages cÃ¹ng lÃºc**

```
User B gá»­i 3 tin liÃªn tiáº¿p trong 5 giÃ¢y
â†’ 3 SignalR events
â†’ Frontend debounce updates (100ms)
â†’ Chá»‰ 1 láº§n resort & 1 flash effect
â†’ Unread badge = 3
```

**Case 1.2: User Ä‘ang scroll xuá»‘ng xem conversation cÅ©**

```
User scroll down â†’ scrollTop = 500px
New message arrives
â†’ Resort list (Y lÃªn Ä‘áº§u)
â†’ RESTORE scrollTop = 500px (khÃ´ng jump lÃªn Ä‘áº§u)
â†’ User váº«n tháº¥y conversation cÅ© mÃ¬nh Ä‘ang xem
```

**Case 1.3: Nháº­n tin trong conversation Ä‘ang active**

```
User Ä‘ang xem Conversation Y
User B gá»­i tin má»›i vÃ o Y
â†’ Message append vÃ o chat (useMessageRealtime)
â†’ Conversation list KHÃ”NG update unread (vÃ¬ Ä‘Ã£ active)
â†’ Call markConversationAsRead(Y) tá»± Ä‘á»™ng
```

---

### Flow 2: Send Message (Input & Auto-focus)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER ACTIONS                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ 1. User focus vÃ o textarea
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Textarea State:                            â”‚
        â”‚  âœ… border-blue-500                         â”‚
        â”‚  âœ… Show helper text "Shift+Enter..."       â”‚
        â”‚  âœ… Placeholder disappears                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ 2a. User gÃµ "Hello"
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Textarea: "Hello"                          â”‚
        â”‚  Send Button: ENABLED (blue-600)            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ 2b. User nháº¥n Shift+Enter
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Textarea: "Hello\n" â† Cursor xuá»‘ng dÃ²ng 2  â”‚
        â”‚  Height: 40px â†’ 60px (auto-resize)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ 2c. User gÃµ tiáº¿p "World"
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Textarea: "Hello\nWorld"                   â”‚
        â”‚  Height: 60px                               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ 3. User nháº¥n Enter (khÃ´ng Shift)
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Event Handler:                             â”‚
        â”‚  âœ… preventDefault() â†’ KhÃ´ng xuá»‘ng dÃ²ng     â”‚
        â”‚  âœ… Call sendMessage("Hello\nWorld")        â”‚
        â”‚  âœ… Clear textarea value = ""               â”‚
        â”‚  âœ… Reset height = 40px                     â”‚
        â”‚  âœ… inputRef.current.focus() â† AUTO-FOCUS   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  4. Post-send State:                        â”‚
        â”‚  âœ… Textarea: "" (empty, focused)           â”‚
        â”‚  âœ… Cursor: active, sáºµn sÃ ng gÃµ tin tiáº¿p    â”‚
        â”‚  âœ… Send Button: DISABLED (gray-300)        â”‚
        â”‚  âœ… Message hiá»ƒn thá»‹ trong chat             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Alternative Flow: Click Send Button**

```
User gÃµ tin â†’ Click ðŸ”˜ Send button
â†’ Same behavior nhÆ° nháº¥n Enter
â†’ Auto-focus vÃ o textarea
```

**Alternative Flow: Paste Multi-line Text**

```
User copy tá»« notepad:
  "Line 1
   Line 2
   Line 3"

User Ctrl+V vÃ o textarea
â†’ Paste event fires
â†’ Textarea value = "Line 1\nLine 2\nLine 3"
â†’ Auto-resize: 40px â†’ 80px (3 dÃ²ng)
â†’ KHÃ”NG auto-submit (chá»‰ Enter triggers submit)
```

**Edge Case: Paste text > 5 lines**

```
User paste 10 dÃ²ng
â†’ Textarea height = 120px (MAX)
â†’ Scrollbar appears
â†’ User scroll Ä‘á»ƒ xem content
```

---

### Flow 3: Conversation Sorting (Latest First)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   INITIAL STATE (Sorted)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        Conversation List (sortedBy: lastMessage.sentAt DESC)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Conv A        â”‚ lastMessage: 14:30 (newest)
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Conv B        â”‚ lastMessage: 14:15
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Conv C        â”‚ lastMessage: 13:50
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Conv D        â”‚ lastMessage: 10:20 (oldest)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â”‚
                            â”‚ 1. New message arrives for Conv C
                            â”‚    sentAt: 14:45 (now newest)
                            â–¼

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  2. Update Conv C data:                     â”‚
        â”‚  convC.lastMessage = new message            â”‚
        â”‚  convC.lastMessage.sentAt = "14:45"         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â”‚
                            â”‚ 3. Resort array
                            â–¼

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  sortConversations(conversations, (a, b) => â”‚
        â”‚    new Date(b.lastMessage.sentAt) -         â”‚
        â”‚    new Date(a.lastMessage.sentAt)           â”‚
        â”‚  )                                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â”‚
                            â–¼

        NEW ORDER (Conv C nháº£y lÃªn Ä‘áº§u)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Conv C        â”‚ lastMessage: 14:45 â† MOVED UP
        â”‚ [Flash yellow]â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Conv A        â”‚ lastMessage: 14:30
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Conv B        â”‚ lastMessage: 14:15
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Conv D        â”‚ lastMessage: 10:20
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â”‚
                            â”‚ 4. Lock scroll position
                            â”‚    (user khÃ´ng bá»‹ auto-scroll)
                            â–¼

        User Ä‘ang xem Conv B (scrollTop = 200px)
        â†’ Sau resort, váº«n giá»¯ scrollTop = 200px
        â†’ User KHÃ”NG bá»‹ jump lÃªn Ä‘áº§u list
```

**Performance Optimization:**

```typescript
// Chá»‰ resort khi cÃ³ thay Ä‘á»•i thá»© tá»±
const shouldResort = useMemo(() => {
  const currentOrder = conversations.map((c) => c.id);
  const newOrder = sortedConversations.map((c) => c.id);
  return JSON.stringify(currentOrder) !== JSON.stringify(newOrder);
}, [conversations]);

if (shouldResort) {
  // Resort & lock scroll
}
```

---

### Flow 4: Unread Count Sync (Cross-tabs via SignalR)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MULTI-TAB SCENARIO                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        TAB 1                           TAB 2
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Conv A [3]    â”‚               â”‚ Conv A [3]    â”‚
        â”‚ Conv B (active)â”‚              â”‚ Conv B        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        SignalR Connected               SignalR Connected

                            â”‚
                            â”‚ 1. User trong TAB 1 click Conv A
                            â–¼

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  TAB 1 Actions:                             â”‚
        â”‚  âœ… Switch to Conv A                        â”‚
        â”‚  âœ… Call markConversationAsRead(A)          â”‚
        â”‚  âœ… Hide badge: [3] â†’ (none)                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â”‚
                            â”‚ 2. Backend processes
                            â–¼

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Backend:                                   â”‚
        â”‚  âœ… Update DB: Conv A unreadCount = 0       â”‚
        â”‚  âœ… Broadcast SignalR: MessageRead event    â”‚
        â”‚     {                                       â”‚
        â”‚       conversationId: A,                    â”‚
        â”‚       userId: currentUser.id                â”‚
        â”‚     }                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚
                    â–¼               â–¼
        TAB 1 receives event    TAB 2 receives event

        TAB 1                           TAB 2
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Conv A        â”‚               â”‚ Conv A        â”‚ â† Badge removed
        â”‚ (active, no   â”‚               â”‚ (Badge [3]    â”‚    automatically!
        â”‚  badge update â”‚               â”‚  â†’ removed)   â”‚
        â”‚  needed)      â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â”‚
                            â–¼

        RESULT: Both tabs synced!
        - TAB 1: Conv A active, no badge (correct)
        - TAB 2: Conv A badge removed (synced from TAB 1)
```

**Event Handler (both tabs):**

```typescript
signalRConnection.on("MessageRead", (event) => {
  const { conversationId, userId } = event;

  // Chá»‰ update náº¿u ngÆ°á»i Ä‘á»c lÃ  current user
  if (userId === currentUser.id) {
    updateConversation(conversationId, { unreadCount: 0 });
  }
});
```

**Edge Case: User Ä‘á»c trong mobile app**

```
User má»Ÿ app trÃªn mobile â†’ Äá»c Conv A
â†’ Backend broadcast MessageRead
â†’ All tabs/devices (desktop Tab 1, Tab 2, mobile) Ä‘á»u nháº­n event
â†’ All update badge vá» 0
```

---

### Flow 5: Error Handling

#### Error 5.1: SignalR Disconnected

```
        User Ä‘ang chat bÃ¬nh thÆ°á»ng
                    â”‚
                    â”‚ Network issue / Server restart
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  SignalR Connection Lost                    â”‚
        â”‚  Event: 'onclose'                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  UI Notification:                           â”‚
        â”‚  âš ï¸ "Káº¿t ná»‘i bá»‹ giÃ¡n Ä‘oáº¡n, Ä‘ang káº¿t ná»‘i     â”‚
        â”‚      láº¡i..."                                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Auto-reconnect (5s, 10s, 30s intervals)
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Reconnect Success:                         â”‚
        â”‚  âœ… Re-establish SignalR connection         â”‚
        â”‚  âœ… Fetch latest conversations (refresh)    â”‚
        â”‚  âœ… Sync unread counts                      â”‚
        â”‚  âœ… Hide notification                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Error 5.2: markAsRead API Failed

```
        User click Conv A (has 5 unread)
                    â”‚
                    â”‚ Call markConversationAsRead(A)
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  API Response: 500 Internal Server Error    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Optimistic update already done (badge hidden)
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Error Handler:                             â”‚
        â”‚  âœ… Rollback: Restore badge [5]             â”‚
        â”‚  âœ… Show toast: "KhÃ´ng thá»ƒ Ä‘Ã¡nh dáº¥u Ä‘Ã£ Ä‘á»c" â”‚
        â”‚  âœ… Retry sau 3s (silent)                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Error 5.3: Send Message Failed (Input flow)

```
        User gÃµ tin â†’ Nháº¥n Enter
                    â”‚
                    â”‚ Call sendMessage()
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  API Failed: Network error                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Error Handling:                            â”‚
        â”‚  âŒ Message KHÃ”NG clear khá»i input          â”‚
        â”‚  âŒ Input KHÃ”NG auto-focus (vÃ¬ failed)      â”‚
        â”‚  âœ… Show error toast                        â”‚
        â”‚  âœ… Disable Send button â†’ Retry button      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ User click Retry
                    â–¼
        Retry sendMessage() â†’ Success
        â†’ Clear input, auto-focus
```

---

## ðŸ”€ State Transitions

### Conversation Item State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ LOADING â”‚ (Initial fetch)
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              LOADED                    â”‚
    â”‚  (Has data, not active, no unread)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚              â”‚
         â”‚ New msg        â”‚ Click        â”‚ Receive msg
         â”‚ (other conv)   â”‚              â”‚ (this conv)
         â–¼                â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ UNREAD  â”‚      â”‚ ACTIVE  â”‚   â”‚ UNREAD + â”‚
    â”‚ [Badge] â”‚      â”‚(Blue BG)â”‚   â”‚ JUST_UP  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ (Flash)  â”‚
         â”‚                â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Click          â”‚ New msg      â”‚ 2s
         â”‚                â”‚ (other)      â”‚ timeout
         â–¼                â–¼              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ACTIVE  â”‚â—„â”€â”€â”€â”€â”€â”¤ ACTIVE  â”‚   â”‚ UNREAD  â”‚
    â”‚(No badge)â”‚      â”‚ +UNREAD â”‚   â”‚         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚(Other   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ conv)   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Input State Machine

```
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  EMPTY  â”‚ (value = "")
            â”‚ Disabledâ”‚
            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                 â”‚ User types
                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ HAS_TEXTâ”‚ (value.length > 0)
            â”‚ Enabled â”‚
            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                 â”‚ Shift+Enter
                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚MULTILINEâ”‚ (height > 40px)
            â”‚ Enabled â”‚
            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                 â”‚ Enter (send)
                 â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ SENDING â”‚ (API call pending)
            â”‚ Disabledâ”‚
            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚        â”‚
         Success    Error
             â–¼        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  EMPTY  â”‚ â”‚HAS_TEXT â”‚
        â”‚ Focused â”‚ â”‚+ ERROR  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“Š Sequence Diagrams

### Diagram 1: Full Cycle - User A sends, User B receives

```
User A          Frontend A       Backend         Frontend B      User B
  â”‚                 â”‚                â”‚                â”‚              â”‚
  â”‚ Type & Send     â”‚                â”‚                â”‚              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚              â”‚
  â”‚                 â”‚ POST /messages â”‚                â”‚              â”‚
  â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚              â”‚
  â”‚                 â”‚                â”‚ Broadcast      â”‚              â”‚
  â”‚                 â”‚                â”‚ MessageSent    â”‚              â”‚
  â”‚                 â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚
  â”‚                 â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚              â”‚
  â”‚                 â”‚ (also receives)â”‚                â”‚              â”‚
  â”‚                 â”‚                â”‚                â”‚ Update UI    â”‚
  â”‚                 â”‚ Update sent    â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                 â”‚ message        â”‚                â”‚              â”‚
  â”‚ See own msg     â”‚                â”‚                â”‚ See new msg  â”‚
  â”‚ Input cleared   â”‚                â”‚                â”‚ Badge [1]    â”‚
  â”‚ Auto-focused    â”‚                â”‚                â”‚ Flash effect â”‚
  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚                â”‚              â”‚
  â”‚                 â”‚                â”‚                â”‚              â”‚
  â”‚                 â”‚                â”‚                â”‚ Click conv   â”‚
  â”‚                 â”‚                â”‚  POST mark-readâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                 â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
  â”‚                 â”‚                â”‚ Broadcast      â”‚              â”‚
  â”‚                 â”‚                â”‚ MessageRead    â”‚              â”‚
  â”‚                 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚
  â”‚                 â”‚ (no-op, diff   â”‚                â”‚ Remove badge â”‚
  â”‚                 â”‚  conv active)  â”‚                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                 â”‚                â”‚                â”‚              â”‚
```

---

## âœ… HUMAN CONFIRMATION

| Háº¡ng má»¥c                        | Status       |
| ------------------------------- | ------------ |
| ÄÃ£ review User Flows            | âœ… ÄÃ£ review |
| ÄÃ£ review State Transitions     | âœ… ÄÃ£ review |
| ÄÃ£ review Error Handling        | âœ… ÄÃ£ review |
| **APPROVED Ä‘á»ƒ tiáº¿p tá»¥c BÆ¯á»šC 4** | âœ… APPROVED  |

**HUMAN Signature:** [ÄÃƒ DUYá»†T]  
**Date:** 2026-01-07

> âœ… **Flow approved - AI Ä‘Æ°á»£c phÃ©p tiáº¿p tá»¥c BÆ¯á»šC 4**

---

_Last updated: 2026-01-07_
