# Phase 2.2 - Document Preview in Modal

> **Feature:** Preview PDF/Excel/Word documents trong popup "Táº¥t cáº£ file"  
> **Parent:** View Files Phase 2 (Jump to Message)  
> **Status:** ğŸ“ Planning  
> **Priority:** Medium  
> **Created:** 2026-01-16

---

## ğŸ“‹ Feature Summary

Má»Ÿ rá»™ng popup "Táº¥t cáº£ file trong Ä‘oáº¡n chat" Ä‘á»ƒ preview Ä‘Æ°á»£c documents, khÃ´ng chá»‰ image/video.

**Current State (Phase 2.0 & 2.1):**

- âœ… Image/Video preview works
- âœ… Jump to message with auto-load
- âŒ Documents (PDF/Excel/Word) chá»‰ hiá»ƒn thá»‹ placeholder

**Phase 2.2 Addition:**

- ğŸ“„ **PDF** - Multi-page viewer vá»›i pagination
- ğŸ“Š **Excel** (.xlsx, .xls) - Spreadsheet viewer vá»›i sheet tabs
- ğŸ“ **Word** (.docx, .doc) - Document viewer vá»›i scroll

**Base Component:** `FileManagerPhase1A.tsx` (SimpleModal preview, lines 920-950)

---

## ğŸ¯ Goals

### Primary

1. âœ… User cÃ³ thá»ƒ preview PDF documents vá»›i pagination
2. âœ… User cÃ³ thá»ƒ preview Excel spreadsheets
3. âœ… User cÃ³ thá»ƒ preview Word documents

### Secondary

1. Smooth loading experience vá»›i skeleton states
2. Error handling cho unsupported files
3. Download fallback náº¿u preview fail

---

## ğŸ—ï¸ Current State vs Target State

### Current State (FileManagerPhase1A.tsx, lines 943-947)

```tsx
{
  previewFile && previewFile.kind === "doc" && (
    <div className="rounded-lg border border-dashed p-4 text-sm text-gray-500">
      Xem trÆ°á»›c tÃ i liá»‡u sáº½ Ä‘Æ°á»£c tÃ­ch há»£p vá»›i viewer PDF/Office á»Ÿ bÆ°á»›c tiáº¿p
      theo.
    </div>
  );
}
```

**Limitations:**

- âŒ Chá»‰ hiá»ƒn thá»‹ placeholder text
- âŒ KhÃ´ng preview Ä‘Æ°á»£c ná»™i dung file
- âŒ User pháº£i download Ä‘á»ƒ xem

### Target State

```tsx
{
  previewFile && previewFile.kind === "doc" && (
    <DocumentViewer
      fileId={previewFile.fileId}
      fileName={previewFile.name}
      fileExtension={previewFile.ext}
      onError={() => setPreviewFile(null)}
    />
  );
}
```

**Features:**

- âœ… PDF viewer vá»›i pagination (page 1/10)
- âœ… Excel viewer vá»›i sheet tabs
- âœ… Word viewer vá»›i scroll
- âœ… Skeleton loading states
- âœ… Error states vá»›i download fallback

---

## ğŸ”§ Technical Foundation

### Existing APIs (Already Implemented)

#### 1. `getFilePreview` API

```typescript
// src/api/filePreview.api.ts
export async function getFilePreview(
  request: FilePreviewRequest
): Promise<FilePreviewResponse> {
  // GET /api/Files/{fileId}/preview?page={pageNumber}
  // Returns: Blob image + headers['x-total-pages']
}
```

**Supports:**

- âœ… PDF preview (page by page)
- âœ… Image preview (single page)
- âœ… Pagination via `page` query param
- âœ… Returns: Binary blob (image) + total pages header

#### 2. `usePdfPreview` Hook

```typescript
// src/hooks/usePdfPreview.ts
export function usePdfPreview(fileId: string) {
  // Returns: { objectUrl, isLoading, error, totalPages }
}
```

**Features:**

- âœ… Fetch single page as blob
- âœ… Create object URL for rendering
- âœ… Auto cleanup on unmount
- âœ… Error handling

### What We Need to Build

1. **DocumentViewer Component** - Main viewer vá»›i type detection
2. **PdfViewer Component** - Multi-page PDF viewer (extends usePdfPreview)
3. **ExcelViewer Component** - Spreadsheet viewer (new API needed?)
4. **WordViewer Component** - Document viewer (uses getFilePreview?)

---

## ğŸ“Š Comparison with Phase 2.0/2.1

| Feature        | Phase 2.0 (Image)  | Phase 2.1 (Jump)    | Phase 2.2 (Documents) |
| -------------- | ------------------ | ------------------- | --------------------- |
| Component      | BlobImage          | handleJumpToMessage | DocumentViewer        |
| API            | BlobImage internal | messagesQuery       | getFilePreview        |
| Loading State  | "Äang táº£i..."      | Toast notifications | Skeleton              |
| Error Handling | "Lá»—i táº£i áº£nh"      | Toast error         | Download fallback     |
| Pagination     | N/A                | N/A                 | âœ… Required for PDF   |
| Multi-sheet    | N/A                | N/A                 | âœ… Required for Excel |

---

## ğŸ—‚ï¸ File Structure (Planned)

```
src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ document-viewer/           # ğŸ†• NEW
â”‚       â”œâ”€â”€ DocumentViewer.tsx     # Main component (type router)
â”‚       â”œâ”€â”€ PdfViewer.tsx          # PDF with pagination
â”‚       â”œâ”€â”€ ExcelViewer.tsx        # Excel with sheet tabs
â”‚       â”œâ”€â”€ WordViewer.tsx         # Word with scroll
â”‚       â””â”€â”€ index.ts               # Exports
â”‚
â”œâ”€â”€ api/
â”‚   â””â”€â”€ filePreview.api.ts         # âœ… EXISTS (may need extension)
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ usePdfPreview.ts           # âœ… EXISTS
â”‚   â””â”€â”€ useDocumentPreview.ts      # ğŸ†• NEW (generic hook)
â”‚
â””â”€â”€ features/portal/components/
    â””â”€â”€ FileManagerPhase1A.tsx     # ğŸ”§ MODIFY (integrate DocumentViewer)
```

---

## ğŸ“ Documentation Structure

This feature follows the standard workflow:

- âœ… **v2.2_00_overview.md** - This file (overview)
- â³ **v2.2_01_requirements.md** - Detailed functional requirements
- â³ **v2.2_02a_wireframe.md** - UI/UX designs for viewers
- â³ **v2.2_02b_flow.md** - User flow diagrams
- â³ **v2.2_03_api-verification.md** - API verification (getFilePreview)
- â³ **v2.2_04_implementation-plan.md** - Code implementation roadmap
- â³ **v2.2_06_testing.md** - Test requirements & cases

---

## ğŸš¦ Next Steps

1. **HUMAN Decision Required:**

   - Excel preview: Use server-side rendering or client library?
   - Word preview: Render as images (like PDF) or HTML?
   - Max file size limit for preview? (e.g., 50MB)

2. **Create Requirements Document** (v2.2_01_requirements.md)
3. **Verify API Support** for Excel/Word preview
4. **Design UI Wireframes** for each viewer type

---

## ğŸ”— Related Files

- Phase 2.0 Docs: [view-files-phase-2/](f:/Working/NgocMinhV2/QUOCNAM/WebUser/docs/modules/chat/features/view-files-phase-2/)
- Current Implementation: [FileManagerPhase1A.tsx](f:/Working/NgocMinhV2/QUOCNAM/WebUser/src/features/portal/components/FileManagerPhase1A.tsx#L920-L950)
- Existing API: [filePreview.api.ts](f:/Working/NgocMinhV2/QUOCNAM/WebUser/src/api/filePreview.api.ts)
- Existing Hook: [usePdfPreview.ts](f:/Working/NgocMinhV2/QUOCNAM/WebUser/src/hooks/usePdfPreview.ts)

---

## âš ï¸ Constraints & Considerations

### Technical

- Backend API há»— trá»£ preview Excel/Word chÆ°a? (cáº§n verify)
- Excel cÃ³ thá»ƒ cÃ³ nhiá»u sheets â†’ cáº§n tab UI
- Word cÃ³ thá»ƒ ráº¥t dÃ i â†’ cáº§n scroll + lazy load?
- File size limit Ä‘á»ƒ trÃ¡nh OOM

### UX

- Loading time cÃ³ thá»ƒ lÃ¢u â†’ cáº§n progress indicator
- Mobile view sáº½ khÃ³ vá»›i Excel (nhiá»u columns)
- Fallback download button luÃ´n hiá»ƒn thá»‹

### Performance

- Object URL cleanup Ä‘á»ƒ trÃ¡nh memory leak
- Cache preview images giá»¯a cÃ¡c láº§n má»Ÿ/Ä‘Ã³ng
- Lazy load pages cho PDF dÃ i

---

**Version:** 1.0  
**Last Updated:** 2026-01-16  
**Author:** AI Assistant
