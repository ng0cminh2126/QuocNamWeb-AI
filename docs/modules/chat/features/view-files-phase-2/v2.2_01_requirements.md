# [Phase 2.2 - BÆ¯á»šC 1] Requirements - File Preview Enhancement

> **Feature:** Preview Image/PDF/Excel/Word trong popup "Táº¥t cáº£ file"  
> **Version:** 2.2.0  
> **Status:** âœ… APPROVED - Ready for implementation  
> **Created:** 2026-01-16  
> **Approved:** 2026-01-16

---

## ğŸ“‹ OVERVIEW

### Objective

**Má»Ÿ modal preview file Ä‘ang cÃ³** khi user click vÃ o file (Image/PDF/Excel/Word) trong popup "Táº¥t cáº£ file".

**âœ… Sá»¬ Dá»¤NG HOÃ€N TOÃ€N EXISTING COMPONENTS - KHÃ”NG Bá»” SUNG LOGIC Má»šI**

- **Image files:** Use ImagePreviewModal (watermarked, keyboard navigation)
- **Document files (PDF/Excel/Word):** Use FilePreviewModal (pagination, sheets, etc.)

### Scope

- âœ… IN SCOPE: Integrate existing ImagePreviewModal vÃ o FileManagerPhase1A cho image files
- âœ… IN SCOPE: Integrate existing FilePreviewModal vÃ o FileManagerPhase1A cho document files
- âœ… IN SCOPE: Pass file data to existing modals
- âŒ OUT OF SCOPE: Táº¥t cáº£ logic preview (Ä‘Ã£ cÃ³ sáºµn trong existing modals)
- âŒ OUT OF SCOPE: Custom pagination/sheet tabs/error handling (existing components handle)
- âŒ OUT OF SCOPE: File editing, download, annotation, print

### Relationship to Phase 2.0/2.1

- **Phase 2.0:** Basic file listing trong information panel
- **Phase 2.1:** Jump to message vá»›i auto-load + highlight
- **Phase 2.2:** Document preview capability (this phase)

---

## ğŸ¯ FUNCTIONAL REQUIREMENTS

### FR-1: Replace Image Preview Modal

**Description:** Thay SimpleModal+BlobImage báº±ng ImagePreviewModal khi preview áº£nh

**Current Behavior:**

- Click áº£nh â†’ SimpleModal má»Ÿ vá»›i BlobImage component bÃªn trong

**New Behavior:**

- Click áº£nh â†’ ImagePreviewModal má»Ÿ (watermarked, keyboard shortcuts, download button)

**KHÃ”NG thay Ä‘á»•i:**

- âœ… User flow giá»¯ nguyÃªn (click thumbnail â†’ preview)
- âœ… Logic handleOpenPreview giá»¯ nguyÃªn
- âœ… previewFile state giá»¯ nguyÃªn

**CHá»ˆ thay Ä‘á»•i:**

- âŒ XÃ³a: `<SimpleModal><BlobImage /></SimpleModal>` cho image
- âœ… ThÃªm: `<ImagePreviewModal fileId={...} fileName={...} />`

**Acceptance Criteria:**

- [ ] Click vÃ o thumbnail áº£nh â†’ ImagePreviewModal má»Ÿ (thay vÃ¬ SimpleModal)
- [ ] Modal hiá»ƒn thá»‹ watermarked preview
- [ ] Keyboard shortcuts work (â†â†’, Esc)
- [ ] Download button available
- [ ] Close modal â†’ vá» láº¡i popup "Táº¥t cáº£ file"

**Dependencies:**

- âœ… ImagePreviewModal component (ALREADY EXISTS in @/components)

---

### FR-2: Replace Document Preview Placeholder

**Description:** Thay placeholder div báº±ng FilePreviewModal khi preview document

**Current Behavior:**

- Click document â†’ SimpleModal má»Ÿ vá»›i div placeholder text

**New Behavior:**

- Click document â†’ FilePreviewModal má»Ÿ (PDF pagination, Excel sheets, Word scroll)

**KHÃ”NG thay Ä‘á»•i:**

- âœ… User flow giá»¯ nguyÃªn (click file row â†’ preview)
- âœ… Logic handleOpenPreview giá»¯ nguyÃªn
- âœ… previewFile state giá»¯ nguyÃªn

**CHá»ˆ thay Ä‘á»•i:**

- âŒ XÃ³a: `<div>Xem trÆ°á»›c tÃ i liá»‡u sáº½ Ä‘Æ°á»£c tÃ­ch há»£p...</div>`
- âœ… ThÃªm: `<FilePreviewModal isOpen={true} fileId={...} fileName={...} />`

**Acceptance Criteria:**

- [ ] Click vÃ o file row â†’ FilePreviewModal má»Ÿ (thay vÃ¬ placeholder)
- [ ] PDF: Pagination controls work
- [ ] Excel: Sheet tabs switching work
- [ ] Word: Scrollable formatted content
- [ ] Close modal â†’ vá» láº¡i popup "Táº¥t cáº£ file"

**Dependencies:**

- âœ… FilePreviewModal component (ALREADY EXISTS in @/components)

---

### ~~FR-2: Excel/Word Specific Requirements~~

**Description:** User cÃ³ thá»ƒ preview Excel files vá»›i sheet tabs

**Acceptance Criteria:**

- [ ] Click vÃ o Excel file (.xlsx, .xls) â†’ má»Ÿ preview
- [ ] Hiá»ƒn thá»‹ list of sheets (tabs)
- [ ] Default: Show first sheet
- [ ] Click sheet tab â†’ switch to that sheet
- [ ] Render sheet as image hoáº·c HTML table

**API Requirement:**

- âš ï¸ **NEEDS VERIFICATION:** Backend cÃ³ há»— trá»£ preview Excel khÃ´ng?
- Option 1: `GET /api/Files/{fileId}/preview?sheet={sheetIndex}` (server-rendered)
- Option 2: Client-side library (e.g., SheetJS) - táº£i file vá» vÃ  render

**UI Components:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š Sales.xlsx                      [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Sheet1] [Sheet2] [Summary]            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ A    â”‚ B     â”‚ C     â”‚ D          â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Name â”‚ Price â”‚ Qty   â”‚ Total      â”‚  â”‚
â”‚  â”‚ ...  â”‚ ...   â”‚ ...   â”‚ ...        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### FR-3: Word Document Preview

**Description:** User cÃ³ thá»ƒ preview Word documents

**Acceptance Criteria:**

- [ ] Click vÃ o Word file (.docx, .doc) â†’ má»Ÿ preview
- [ ] Render document content
- [ ] Scrollable náº¿u document dÃ i
- [ ] Preserve basic formatting (bold, italic, headings)

**API Requirement:**

- âš ï¸ **NEEDS VERIFICATION:** Backend rendering approach?
- Option 1: Convert Word â†’ PDF â†’ render as images (similar to PDF viewer)
- Option 2: Convert Word â†’ HTML (server-side)
- Option 3: Multi-page preview like PDF (`?page=1, 2, 3...`)

**UI Components:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ Contract.docx                   [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Title: Contract Agreement         â”‚  â”‚ <-- Scrollable
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ Lorem ipsum dolor sit amet...     â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚ Section 1: Terms                  â”‚  â”‚
â”‚  â”‚ ...                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### FR-4: Loading States

**Description:** Smooth loading experience khi fetch document preview

**Acceptance Criteria:**

- [ ] Initial load: Show skeleton/spinner
- [ ] Page navigation (PDF): Show loading overlay
- [ ] Sheet switch (Excel): Show loading state
- [ ] Error state: Display user-friendly message + retry button
- [ ] Timeout handling: Show error message after 30s

**Loading UI:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ Document.pdf                    [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚   â”‚  ğŸ”„ Äang táº£i tÃ i liá»‡u... â”‚     â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Error UI:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ Document.pdf                    [X]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   âš ï¸ KhÃ´ng thá»ƒ xem trÆ°á»›c          â”‚  â”‚
â”‚  â”‚   File cÃ³ thá»ƒ bá»‹ há»ng hoáº·c       â”‚  â”‚
â”‚  â”‚   khÃ´ng há»— trá»£ preview.           â”‚  â”‚
â”‚  â”‚                                   â”‚  â”‚
â”‚  â”‚   [Thá»­ láº¡i]    [Táº£i xuá»‘ng]       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ UI/UX REQUIREMENTS

**âœ… KHÃ”NG Cáº¦N CUSTOM UI** - FilePreviewModal Ä‘Ã£ cÃ³ styling hoÃ n chá»‰nh:

- Modal layout, colors, responsive
- Loading skeletons
- Error states
- Pagination/sheet tabs styling

**Chá»‰ cáº§n integrate modal vÃ o FileManagerPhase1A**

---

## ğŸ”§ TECHNICAL REQUIREMENTS

### TR-1: Component Architecture (âœ… REUSE EXISTING)

**âœ… NO NEW COMPONENTS NEEDED - Use existing infrastructure:**

```
FilePreviewModal (ALREADY EXISTS)
â”œâ”€ PdfViewer (via usePdfPreview hook)
â”œâ”€ ExcelPreview (ALREADY EXISTS in file-sheet/)
â””â”€ WordPreview (ALREADY EXISTS in file-sheet/)
```

**Existing Components:**

- âœ… `FilePreviewModal.tsx` - Main modal router (auto-detects file type)
- âœ… `ExcelPreview.tsx` - Excel viewer vá»›i sheet tabs & pagination
- âœ… `WordPreview.tsx` - Word viewer vá»›i HTML conversion
- âœ… `PreviewHeader.tsx` - Shared header component
- âœ… `Watermark.tsx` - Watermark overlay hook

**Integration:**

```typescript
<FilePreviewModal
  open={!!previewFile}
  file={{ id: fileId, name: fileName, url: fileUrl, type: "document" }}
  onOpenChange={(open) => !open && setPreviewFile(null)}
/>
```

### TR-2: Implementation (ACTUAL CODE IMPLEMENTED)

**âœ… COMPLETED - Code changes trong FileManagerPhase1A.tsx:**

**1. Imports (lines 15-16):**

```typescript
import FilePreviewModal from "@/components/FilePreviewModal"; // Phase 2.2: Document preview
import ImagePreviewModal from "@/components/ImagePreviewModal"; // Phase 2.2: Image preview
```

**2. Document Preview Modal (lines ~941-947):**

```typescript
{
  previewFile && previewFile.kind === "doc" && (
    <FilePreviewModal
      isOpen={true}
      fileId={previewFile.fileId || ""}
      fileName={previewFile.name}
      onClose={() => setPreviewFile(null)}
    />
  );
}
```

**3. Image Preview Modal (lines ~916-924):**

```typescript
{
  previewFile && previewFile.kind === "image" && (
    <ImagePreviewModal
      open={true}
      fileId={previewFile.fileId || ""}
      fileName={previewFile.name}
      onOpenChange={(open) => {
        if (!open) setPreviewFile(null);
      }}
    />
  );
}
```

**Táº¥t cáº£ logic (API, performance, error handling, watermark) Ä‘Ã£ cÃ³ sáºµn trong existing modals**

---

## ğŸ§ª TESTING REQUIREMENTS

**Manual Testing:**

- [ ] Click PDF file â†’ FilePreviewModal opens with pagination
- [ ] Click Excel file â†’ FilePreviewModal opens with sheet tabs
- [ ] Click Word file â†’ FilePreviewModal opens with formatted content
- [ ] Click Image file â†’ ImagePreviewModal opens with watermark
- [ ] Close modal (ESC or X button) â†’ returns to file list
- [ ] Navigate pages/sheets â†’ works correctly
- [ ] Error handling â†’ shows retry button

**Implementation Status:**

- âœ… FilePreviewModal integration completed
- âœ… ImagePreviewModal integration completed
- âœ… Props correctly passed (fileId, fileName)
- âœ… No TypeScript errors

**Existing components already have unit tests** - khÃ´ng cáº§n test láº¡i preview logic

**Next Steps:**

- Manual testing vá»›i real API data
- Verify fileId is correctly extracted from messages
- Test error states and retry functionality

---

## â³ PENDING DECISIONS

**âœ… KHÃ”NG Cáº¦N QUYáº¾T Äá»ŠNH GÃŒ** - Sá»­ dá»¥ng hoÃ n toÃ n existing FilePreviewModal vá»›i config hiá»‡n táº¡i:

- âœ… Excel: Client-side rendering (already configured in ExcelPreview)
- âœ… Word: HTML conversion (already configured in WordPreview)
- âœ… File size limit: Use existing limit from FilePreviewModal
- âœ… Mobile responsive: Use existing responsive behavior
- âœ… Cache: Use existing cache strategy
- âœ… Watermark: Use existing Watermark component

**Chá»‰ cáº§n má»Ÿ modal â†’ táº¥t cáº£ logic Ä‘Ã£ cÃ³ sáºµn**

---

## ğŸ“‹ IMPACT SUMMARY

**âœ… IMPLEMENTATION COMPLETED - 1 file modified, ~20 lines changed:**

### Files Ä‘Ã£ táº¡o má»›i:

- (NONE)

### Files Ä‘Ã£ sá»­a Ä‘á»•i:

- âœ… `src/features/portal/components/FileManagerPhase1A.tsx`
  - **Line 15-16:** Added imports
    ```typescript
    import FilePreviewModal from "@/components/FilePreviewModal";
    import ImagePreviewModal from "@/components/ImagePreviewModal";
    ```
  - **Lines ~916-924:** Replaced BlobImage in SimpleModal with ImagePreviewModal
    - BEFORE: `<BlobImage fileId={...} endpoint="preview" />`
    - AFTER: `<ImagePreviewModal open={true} fileId={...} fileName={...} />`
  - **Lines ~941-947:** Replaced placeholder div with FilePreviewModal
    - BEFORE: `<div>Xem trÆ°á»›c tÃ i liá»‡u sáº½ Ä‘Æ°á»£c tÃ­ch há»£p...</div>`
    - AFTER: `<FilePreviewModal isOpen={true} fileId={...} fileName={...} />`
  - **Line ~930:** Updated SimpleModal condition to exclude images
    - BEFORE: `open={!!previewFile}`
    - AFTER: `open={!!previewFile && previewFile.kind !== "image"}`

### Files Ä‘Ã£ xoÃ¡:

- (NONE)

### Dependencies Ä‘Ã£ thÃªm:

- (NONE - Táº¥t cáº£ components Ä‘Ã£ tá»“n táº¡i)

### Logic Ä‘Ã£ bá»• sung:

- (NONE - Chá»‰ integrate existing modals, khÃ´ng custom logic má»›i)
- âœ… FilePreviewModal: Auto-detects file type (PDF/Word/Excel) vÃ  render appropriate viewer
- âœ… ImagePreviewModal: Watermarked preview vá»›i keyboard shortcuts vÃ  download

---

## âœ… HUMAN CONFIRMATION

| Háº¡ng má»¥c                 | Status       |
| ------------------------ | ------------ |
| ÄÃ£ review Impact Summary | âœ… ÄÃ£ review |
| **APPROVED Ä‘á»ƒ thá»±c thi** | âœ… APPROVED  |

**HUMAN Signature:** [ÄÃƒ DUYá»†T]  
**Date:** 2026-01-16

> âœ… **APPROVED - AI cÃ³ thá»ƒ proceed vá»›i implementation**

---

**Version:** 2.2.0  
**Last Updated:** 2026-01-16
